<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ru" dir="ltr" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light" data-menu-styles="light" data-toggled="close">

<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Предложения - MinerHive</title>
    <meta name="Description" content="Все предложения от продавцов">
    
    <!-- Favicon -->
    <link rel="icon" th:href="@{/bootstrap-theme/assets/images/brand-logos/favicon.ico}" href="../assets/images/brand-logos/favicon.ico" type="image/x-icon">
    
    <!-- Bootstrap Css -->
    <link id="style" th:href="@{/bootstrap-theme/assets/libs/bootstrap/css/bootstrap.min.css}" href="../assets/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Style Css -->
    <link th:href="@{/bootstrap-theme/assets/css/styles.min.css}" href="../assets/css/styles.min.css" rel="stylesheet">
    
    <!-- Icons Css -->
    <link th:href="@{/bootstrap-theme/assets/css/icons.css}" href="../assets/css/icons.css" rel="stylesheet">
    
    <!-- Node Waves Css -->
    <link th:href="@{/bootstrap-theme/assets/libs/node-waves/waves.min.css}" href="../assets/libs/node-waves/waves.min.css" rel="stylesheet"> 
    
    <!-- Simplebar Css -->
    <link th:href="@{/bootstrap-theme/assets/libs/simplebar/simplebar.min.css}" href="../assets/libs/simplebar/simplebar.min.css" rel="stylesheet">
    
    <style>
        html {
            overflow-x: hidden !important;
            overflow-y: scroll !important;
            height: 100% !important;
        }
        
        body {
            overflow-x: hidden !important;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 100vh !important;
            position: relative !important;
        }
        
        .page {
            overflow-x: hidden !important;
            overflow-y: visible !important;
            height: auto !important;
            min-height: 100vh !important;
        }
        
        .main-content, .app-content {
            overflow-x: hidden !important;
            overflow-y: visible !important;
            height: auto !important;
            min-height: 100vh !important;
        }
        
        body.modal-open {
            overflow-y: scroll !important;
            padding-right: 0 !important;
        }
        
        .offers-table {
            font-size: 0.875rem;
        }
        
        .offers-table thead th {
            background-color: #2c3e50;
            color: #ffffff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 10px 12px;
            white-space: nowrap;
        }
        
        .offers-table tbody td {
            padding: 8px 12px;
            vertical-align: middle;
        }
        
        .offers-table tbody tr.offer-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .offers-table tbody tr.offer-row:hover {
            background-color: #f8f9fa;
        }
        
        .manufacturer-btn.active, .operation-type-btn.active, .date-filter-btn.active, .series-filter-btn.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #ffffff;
        }
    </style>
</head>

<body>
    <div class="page">
        <header class="app-header">
            <div class="main-header-container container-fluid">
                <div class="header-content-left">
                    <div class="header-element">
                        <div class="horizontal-logo">
                            <a href="/" class="header-logo">
                                <img src="/bootstrap-theme/assets/images/brand-logos/desktop-logo.png" alt="logo" class="desktop-logo">
                                <img src="/bootstrap-theme/assets/images/brand-logos/toggle-logo.png" alt="logo" class="toggle-logo">
                            </a>
                        </div>
                    </div>
                    <div class="header-element">
                        <a aria-label="Hide Sidebar" class="sidemenu-toggle header-link animated-arrow hor-toggle horizontal-navtoggle" data-bs-toggle="sidebar" href="javascript:void(0);">
                            <i class="header-icon fe fe-align-left"></i>
                        </a>
                    </div>
                </div>
                <div class="header-content-right">
                    <div class="header-element header-sidebar">
                        <a href="javascript:void(0);" class="header-link" data-bs-toggle="offcanvas" data-bs-target="#header-sidebar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="header-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </a>
                    </div>
                    <div class="header-element headerProfile-dropdown">
                        <a href="javascript:void(0);" class="header-link dropdown-toggle" id="mainHeaderProfile" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            <i class="fe fe-user fs-20"></i>
                        </a>
                        <ul class="main-header-dropdown dropdown-menu pt-0 header-profile-dropdown dropdown-menu-end main-profile-menu" aria-labelledby="mainHeaderProfile">
                            <li>
                                <div class="main-header-profile bg-primary menu-header-content text-fixed-white">
                                    <div class="my-auto">
                                        <h6 class="mb-0 lh-1 text-fixed-white">
                                            <span>Администратор</span>
                                        </h6>
                                        <span class="fs-11 op-7 lh-1">MinerHive</span>
                                    </div>
                                </div>
                            </li>
                            <li><a class="dropdown-item d-flex" href="/"><i class="bx bx-home fs-18 me-2 op-7"></i>Главная</a></li>
                            <li><a class="dropdown-item d-flex border-block-end" href="/logout"><i class="bx bx-log-out fs-18 me-2 op-7"></i>Выход</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <aside class="app-sidebar sticky" id="sidebar">
            <div class="main-sidebar-header">
                <a href="/" class="header-logo">
                    <img src="/bootstrap-theme/assets/images/brand-logos/desktop-logo.png" alt="logo" class="desktop-logo">
                </a>
            </div>
            <div class="main-sidebar" id="sidebar-scroll">
                <nav class="main-menu-container nav nav-pills flex-column sub-open">
                    <ul class="main-menu">
                        <li class="slide__category"><span class="category-name">Главное</span></li>
                        <li class="slide">
                            <a href="/private" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M5 5h4v6H5zm10 8h4v6h-4zM5 17h4v2H5zM15 5h4v2h-4z" opacity=".3"/><path d="M3 13h8V3H3v10zm2-8h4v6H5V5zm8 16h8V11h-8v10zm2-8h4v6h-4v-6zM13 3v6h8V3h-8zm6 4h-4V5h4v2zM3 21h8v-6H3v6zm2-4h4v2H5v-2z"/></svg>
                                <span class="side-menu__label">Панель управления</span>
                            </a>
                        </li>
                        <li class="slide__category"><span class="category-name">Управление</span></li>
                        <li class="slide">
                            <a href="/private/messages" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                                <span class="side-menu__label">Сообщения</span>
                            </a>
                        </li>
                        <li class="slide">
                            <a href="/private/offers" class="side-menu__item active">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24">
                                    <path d="M0 0h24v24H0V0z" fill="none"/>
                                    <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                                </svg>
                                <span class="side-menu__label">Предложения</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="main-content app-content">
            <div class="container-fluid">
                <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb">
                    <div class="my-auto">
                        <h5 class="page-title fs-21 mb-1">Все предложения</h5>
                        <nav>
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="/">Главная</a></li>
                                <li class="breadcrumb-item"><a href="/private">Панель управления</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Предложения</li>
                            </ol>
                        </nav>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header">
                                <div class="card-title">Все предложения от продавцов</div>
                            </div>
                            <div class="card-body">
                                
                                <!-- Фильтры -->
                                <div class="card mb-3" style="background-color: #f8f9fa;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">Фильтры</h6>
                                        
                                        <!-- Производитель -->
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold mb-2">Производитель</label>
                                            <div class="d-flex flex-wrap gap-2" id="manufacturerFilterContainer">
                                                <button type="button" class="btn btn-outline-primary manufacturer-btn active" data-manufacturer="">Все производители</button>
                                                <button type="button" th:each="mfr : ${manufacturers}" class="btn btn-outline-primary manufacturer-btn" th:data-manufacturer="${mfr}" th:text="${mfr}"></button>
                                            </div>
                                        </div>
                                        
                                        <!-- Серия -->
                                        <div class="mb-3" id="seriesFilterContainer" style="display: none;">
                                            <label class="form-label fw-semibold mb-2">Серия майнера</label>
                                            <div class="d-flex flex-wrap gap-2" id="seriesFilterButtonsContainer">
                                                <button type="button" class="btn btn-outline-warning series-filter-btn active" data-series-filter="" id="allSeriesBtn">Все серии</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Тип операции -->
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold mb-2">Тип операции</label>
                                            <div class="d-flex flex-wrap gap-2" id="operationTypeFilterContainer">
                                                <button type="button" class="btn btn-outline-success operation-type-btn active" data-operation-type="">Все</button>
                                                <button type="button" class="btn btn-outline-success operation-type-btn" data-operation-type="SELL">Продам</button>
                                                <button type="button" class="btn btn-outline-success operation-type-btn" data-operation-type="BUY">Куплю</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Дата -->
                                        <div class="mb-2">
                                            <label class="form-label fw-semibold mb-2">Дата</label>
                                            <div class="d-flex flex-wrap gap-2" id="dateFilterContainer">
                                                <button type="button" class="btn btn-outline-info date-filter-btn active" data-date-filter="">Все даты</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Информация о количестве и кнопка удаления -->
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <div class="text-muted">
                                        Показано <span id="currentCount" th:text="${offersPage.numberOfElements}">0</span> из <span id="totalCount" th:text="${offersPage.totalElements}">0</span>
                                    </div>
                                    <div sec:authorize="hasRole('ADMIN')">
                                        <button type="button" class="btn btn-danger" id="deleteSelectedBtn" disabled onclick="deleteSelectedOffers()">
                                            <i class="fe fe-trash-2"></i> Удалить выбранные
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Таблица -->
                                <div class="table-responsive">
                                    <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                    </div>
                                    <table class="table offers-table text-nowrap" id="offersTable">
                                        <thead>
                                            <tr>
                                                <th sec:authorize="hasRole('ADMIN')" style="width: 40px;">
                                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                                                </th>
                                                <th>ID</th>
                                                <th>Товар</th>
                                                <th>Майнер детали</th>
                                                <th>Продавец</th>
                                                <th>Тип операции</th>
                                                <th>Цена</th>
                                                <th>Количество</th>
                                                <th>Хэшрейт</th>
                                                <th>Состояние</th>
                                                <th>Локация</th>
                                                <th>Примечание</th>
                                                <th>Дата создания</th>
                                            </tr>
                                        </thead>
                                        <tbody id="offersTableBody">
                                            <tr class="offer-row" th:each="offer : ${offers}" th:data-offer-id="${offer.id}">
                                                <td sec:authorize="hasRole('ADMIN')">
                                                    <input type="checkbox" class="offer-checkbox" th:data-offer-id="${offer.id}" onchange="updateDeleteButton()">
                                                </td>
                                                <td th:text="${offer.id}"></td>
                                                <td>
                                                    <span th:text="${offer.product != null ? offer.product.model : '-'}"></span>
                                                </td>
                                                <td>
                                                    <span th:text="${offer.product != null && offer.product.minerDetail != null ? offer.product.minerDetail.standardName : '-'}"></span>
                                                </td>
                                                <td>
                                                    <span th:text="${offer.seller != null ? offer.seller.phone : (offer.sellerPhone != null ? offer.sellerPhone : '-')}"></span>
                                                </td>
                                                <td th:text="${offer.operationType != null ? offer.operationType : '-'}">SELL</td>
                                                <td>
                                                    <span th:if="${offer.price != null && offer.price.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
                                                        <span th:text="${#numbers.formatDecimal(offer.price, 0, 2)}"></span>
                                                        <span th:text="${offer.currency != null ? offer.currency : 'RUB'}"></span>
                                                    </span>
                                                    <span th:if="${offer.price == null || offer.price.compareTo(T(java.math.BigDecimal).ZERO) == 0}" class="text-muted">-</span>
                                                </td>
                                                <td th:text="${offer.quantity != null ? offer.quantity : '-'}"></td>
                                                <td>
                                                    <span th:if="${offer.hashrate != null && !offer.hashrate.isEmpty()}" th:text="${offer.hashrate}"></span>
                                                    <span th:if="${offer.hashrate == null || offer.hashrate.isEmpty()}" class="text-muted">-</span>
                                                </td>
                                                <td>
                                                    <span th:if="${offer.condition != null && !offer.condition.isEmpty()}" th:text="${offer.condition}"></span>
                                                    <span th:if="${offer.condition == null || offer.condition.isEmpty()}" class="text-muted">-</span>
                                                </td>
                                                <td>
                                                    <span th:if="${offer.location != null && !offer.location.isEmpty()}" th:text="${offer.location}"></span>
                                                    <span th:if="${offer.location == null || offer.location.isEmpty()}"></span>
                                                </td>
                                                <td>
                                                    <span th:if="${offer.notes != null && !offer.notes.isEmpty()}" th:text="${offer.notes}"></span>
                                                    <span th:if="${offer.notes == null || offer.notes.isEmpty()}" class="text-muted">-</span>
                                                </td>
                                                <td th:text="${#temporals.format(offer.createdAt, 'dd.MM.yyyy HH:mm')}"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Пагинация -->
                                <nav id="paginationNav" class="mt-3" aria-label="Навигация по страницам">
                                    <ul class="pagination justify-content-center" id="paginationContainer">
                                        <li class="page-item" th:classappend="${offersPage.first} ? 'disabled' : ''">
                                            <a class="page-link" th:href="@{/private/offers(page=${offersPage.number - 1}, size=${pageSize}, manufacturer=${selectedManufacturer}, operationType=${selectedOperationType}, dateFilter=${selectedDateFilter})}">Предыдущая</a>
                                        </li>
                                        <li class="page-item" th:each="i : ${#numbers.sequence(0, offersPage.totalPages - 1)}" th:classappend="${i == offersPage.number} ? 'active' : ''">
                                            <a class="page-link" th:href="@{/private/offers(page=${i}, size=${pageSize}, manufacturer=${selectedManufacturer}, operationType=${selectedOperationType}, dateFilter=${selectedDateFilter})}" th:text="${i + 1}"></a>
                                        </li>
                                        <li class="page-item" th:classappend="${offersPage.last} ? 'disabled' : ''">
                                            <a class="page-link" th:href="@{/private/offers(page=${offersPage.number + 1}, size=${pageSize}, manufacturer=${selectedManufacturer}, operationType=${selectedOperationType}, dateFilter=${selectedDateFilter})}">Следующая</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer mt-auto py-3 bg-white text-center">
            <div class="container">
                <span class="text-muted">© 2025 <a href="javascript:void(0);" class="text-dark fw-semibold">MinerHive</a>. Все права защищены.</span>
            </div>
        </footer>
    </div>

    <!-- Off-canvas sidebar -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="header-sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header rounded-0">
            <h5 class="fs-14 text-uppercase mb-0 fw-semibold" id="sidebarLabel">Меню</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body rounded-0 p-0">
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="/private" class="text-dark">Панель управления</a></li>
                <li class="list-group-item"><a href="/private/messages" class="text-dark">Сообщения</a></li>
                <li class="list-group-item"><a href="/private/products/table" class="text-dark">Таблица товаров</a></li>
                <li class="list-group-item"><a href="/private/offers" class="text-dark">Предложения</a></li>
                <li class="list-group-item"><a href="/private/requests" class="text-dark">Заявки</a></li>
                <li class="list-group-item"><a href="/private/miner-details" class="text-dark">Детали майнеров</a></li>
                <li class="list-group-item"><a href="/private/profitability" class="text-dark">Калькулятор доходности</a></li>
                <li class="list-group-item"><a href="/private/users" class="text-dark">Пользователи</a></li>
            </ul>
        </div>
    </div>

    <!-- Модальное окно -->
    <div class="modal fade" id="offerDetailsModal" tabindex="-1" aria-labelledby="offerDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="offerDetailsModalLabel">Полная информация о предложении</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="offerDetailsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/bootstrap-theme/assets/libs/@popperjs/core/umd/popper.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/bootstrap-theme/assets/js/defaultmenu.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/node-waves/waves.min.js"></script>
    <script src="/bootstrap-theme/assets/js/sticky.js"></script>
    <script src="/bootstrap-theme/assets/libs/simplebar/simplebar.min.js"></script>
    <script src="/bootstrap-theme/assets/js/simplebar.js"></script>
    <script src="/bootstrap-theme/assets/js/custom.js"></script>
    <script src="/bootstrap-theme/assets/js/main.js"></script>

    <!-- JavaScript для страницы -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const offersTableBody = document.getElementById('offersTableBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const currentCount = document.getElementById('currentCount');
            const totalCount = document.getElementById('totalCount');
            
            let currentPage = 0;
            const pageSize = 50;
            let filterTimeout;
            let isLoading = false;
            let selectedManufacturer = '';
            let selectedOperationType = '';
            let selectedDateFilter = '';
            let selectedSeries = '';
            
            // Генерация кнопок дат
            function generateDateButtons() {
                const dateFilterContainer = document.getElementById('dateFilterContainer');
                if (!dateFilterContainer) return;
                
                const today = new Date();
                const selectedDate = selectedDateFilter;
                
                for (let i = 0; i < 10; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const day = date.getDate();
                    const buttonText = i === 0 ? 'Сегодня' : day.toString();
                    
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-outline-info date-filter-btn';
                    button.setAttribute('data-date-filter', dateStr);
                    button.textContent = buttonText;
                    
                    if (selectedDate === dateStr) {
                        button.classList.add('active');
                        selectedDateFilter = dateStr;
                    }
                    
                    dateFilterContainer.appendChild(button);
                }
            }
            
            // Получение значений фильтров
            function getFilterValues() {
                const activeManufacturerBtn = document.querySelector('.manufacturer-btn.active');
                selectedManufacturer = activeManufacturerBtn ? (activeManufacturerBtn.dataset.manufacturer || '') : '';
                
                const activeOperationTypeBtn = document.querySelector('.operation-type-btn.active');
                selectedOperationType = activeOperationTypeBtn ? (activeOperationTypeBtn.dataset.operationType || '') : '';
                
                const activeDateBtn = document.querySelector('.date-filter-btn.active');
                selectedDateFilter = activeDateBtn ? (activeDateBtn.dataset.dateFilter || '') : '';
                
                const activeSeriesBtn = document.querySelector('.series-filter-btn.active');
                selectedSeries = activeSeriesBtn ? (activeSeriesBtn.dataset.seriesFilter || '') : '';
                
                return {
                    manufacturer: selectedManufacturer,
                    operationType: selectedOperationType,
                    dateFilter: selectedDateFilter,
                    series: selectedSeries
                };
            }
            
            // Загрузка серий
            function loadSeriesByManufacturer(manufacturer) {
                const seriesFilterContainer = document.getElementById('seriesFilterContainer');
                const seriesFilterButtonsContainer = document.getElementById('seriesFilterButtonsContainer');
                
                if (!manufacturer || manufacturer.trim() === '') {
                    if (seriesFilterContainer) {
                        seriesFilterContainer.style.display = 'none';
                    }
                    selectedSeries = '';
                    return;
                }
                
                if (seriesFilterContainer) {
                    seriesFilterContainer.style.display = 'block';
                }
                
                if (seriesFilterButtonsContainer) {
                    const allSeriesBtn = document.getElementById('allSeriesBtn');
                    seriesFilterButtonsContainer.innerHTML = '';
                    if (allSeriesBtn) {
                        allSeriesBtn.classList.add('active');
                        seriesFilterButtonsContainer.appendChild(allSeriesBtn);
                    } else {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-warning series-filter-btn active';
                        btn.setAttribute('data-series-filter', '');
                        btn.id = 'allSeriesBtn';
                        btn.textContent = 'Все серии';
                        seriesFilterButtonsContainer.appendChild(btn);
                    }
                }
                
                fetch(`/private/offers/series?manufacturer=${encodeURIComponent(manufacturer)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Ошибка загрузки серий');
                    return response.json();
                })
                .then(series => {
                    if (seriesFilterButtonsContainer) {
                        series.forEach(serie => {
                            const button = document.createElement('button');
                            button.type = 'button';
                            button.className = 'btn btn-outline-warning series-filter-btn';
                            button.setAttribute('data-series-filter', serie);
                            button.textContent = serie;
                            seriesFilterButtonsContainer.appendChild(button);
                        });
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки серий:', error);
                });
            }
            
            // Загрузка данных
            function loadOffers(page = 0) {
                if (isLoading) return;
                
                isLoading = true;
                currentPage = page;
                window.currentPage = page; // Обновляем глобальную переменную
                const filters = getFilterValues();
                
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (offersTableBody) offersTableBody.style.opacity = '0.5';
                
                const url = new URL('/private/offers/ajax', window.location.origin);
                url.searchParams.append('page', page);
                url.searchParams.append('size', pageSize);
                if (filters.manufacturer) url.searchParams.append('manufacturer', filters.manufacturer);
                if (filters.operationType) url.searchParams.append('operationType', filters.operationType);
                if (filters.dateFilter) url.searchParams.append('dateFilter', filters.dateFilter);
                if (filters.series) url.searchParams.append('series', filters.series);
                
                fetch(url.toString(), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('Ошибка загрузки данных: ' + response.status);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (offersTableBody) {
                        offersTableBody.innerHTML = data.html || '<tr><td colspan="12" class="text-center py-24 text-muted">Предложения не найдены</td></tr>';
                    }
                    
                    if (currentCount && totalCount) {
                        const start = data.currentPage * data.pageSize + 1;
                        const end = start + data.numberOfElements - 1;
                        currentCount.textContent = end;
                        totalCount.textContent = data.totalElements;
                    }
                    
                    updatePagination(data);
                    setupRowClickHandlers();
                    updateDeleteButton();
                    
                    // Сбрасываем чекбокс "Выбрать все"
                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = false;
                    }
                    
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (offersTableBody) offersTableBody.style.opacity = '1';
                    isLoading = false;
                })
                .catch(error => {
                    console.error('Ошибка загрузки предложений:', error);
                    if (offersTableBody) {
                        offersTableBody.innerHTML = '<tr><td colspan="12" class="text-center py-24 text-danger">Ошибка загрузки данных</td></tr>';
                    }
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (offersTableBody) offersTableBody.style.opacity = '1';
                    isLoading = false;
                });
            }
            
            // Обновление пагинации
            function updatePagination(data) {
                const paginationNav = document.getElementById('paginationNav');
                const paginationContainer = document.getElementById('paginationContainer');
                
                if (!paginationNav || !paginationContainer) return;
                
                if (data.totalPages <= 1) {
                    paginationNav.style.display = 'none';
                    return;
                }
                
                paginationNav.style.display = 'block';
                let paginationHTML = '';
                
                paginationHTML += '<li class="page-item' + (data.currentPage === 0 ? ' disabled' : '') + '">';
                paginationHTML += '<a class="page-link" href="javascript:void(0);" onclick="loadOffers(' + (data.currentPage - 1) + ')">Предыдущая</a>';
                paginationHTML += '</li>';
                
                for (let i = 0; i < data.totalPages; i++) {
                    paginationHTML += '<li class="page-item' + (i === data.currentPage ? ' active' : '') + '">';
                    paginationHTML += '<a class="page-link" href="javascript:void(0);" onclick="loadOffers(' + i + ')">' + (i + 1) + '</a>';
                    paginationHTML += '</li>';
                }
                
                paginationHTML += '<li class="page-item' + (data.currentPage >= data.totalPages - 1 ? ' disabled' : '') + '">';
                paginationHTML += '<a class="page-link" href="javascript:void(0);" onclick="loadOffers(' + (data.currentPage + 1) + ')">Следующая</a>';
                paginationHTML += '</li>';
                
                paginationContainer.innerHTML = paginationHTML;
            }
            
            // Обработчики фильтров
            function handleManufacturerClick(event) {
                event.preventDefault();
                event.stopPropagation();
                if (isLoading) return;
                
                document.querySelectorAll('.manufacturer-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
                const selectedManufacturerValue = event.currentTarget.dataset.manufacturer || '';
                
                setTimeout(() => {
                    loadSeriesByManufacturer(selectedManufacturerValue);
                }, 0);
                
                selectedSeries = '';
                document.querySelectorAll('.series-filter-btn').forEach(btn => btn.classList.remove('active'));
                const allSeriesBtn = document.getElementById('allSeriesBtn');
                if (allSeriesBtn) allSeriesBtn.classList.add('active');
                
                onFilterChange();
            }
            
            function handleSeriesClick(event) {
                event.preventDefault();
                event.stopPropagation();
                if (isLoading) return;
                
                const button = event.target.closest('.series-filter-btn');
                if (!button) return;
                
                document.querySelectorAll('.series-filter-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                onFilterChange();
            }
            
            function handleOperationTypeClick(event) {
                event.preventDefault();
                event.stopPropagation();
                if (isLoading) return;
                
                document.querySelectorAll('.operation-type-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
                onFilterChange();
            }
            
            function handleDateFilterClick(event) {
                event.preventDefault();
                event.stopPropagation();
                if (isLoading) return;
                
                const button = event.target.closest('.date-filter-btn');
                if (!button) return;
                
                document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                selectedDateFilter = button.dataset.dateFilter || '';
                onFilterChange();
            }
            
            function onFilterChange() {
                if (isLoading) {
                    clearTimeout(filterTimeout);
                    return;
                }
                
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    loadOffers(0);
                }, 500);
            }
            
            // Показать детали предложения
            function showOfferDetails(offerId) {
                console.log('Открываем модальное окно для предложения ID:', offerId);
                
                const modalElement = document.getElementById('offerDetailsModal');
                const modalContent = document.getElementById('offerDetailsContent');
                
                if (!modalElement || !modalContent) {
                    console.error('Модальное окно не найдено!');
                    return;
                }
                
                modalContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
                
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
                const requestUrl = `/private/offers/${offerId}/details`;
                
                fetch(requestUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('Ошибка загрузки данных: ' + response.status);
                        });
                    }
                    const contentType = response.headers.get('Content-Type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return response.text().then(text => {
                            throw new Error('Сервер вернул не JSON ответ');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    let html = '<div class="container-fluid">';
                    html += '<h6 class="mb-3">Информация о предложении</h6>';
                    html += '<div class="table-responsive mb-4">';
                    html += '<table class="table table-bordered table-sm">';
                    html += '<tr><th class="w-25">ID предложения</th><td>' + escapeHtml(String(data.offer?.id || '-')) + '</td></tr>';
                    html += '<tr><th>Товар</th><td>' + escapeHtml(String(data.offer?.productModel || '-')) + '</td></tr>';
                    html += '<tr><th>Производитель</th><td>' + escapeHtml(String(data.offer?.manufacturer || '-')) + '</td></tr>';
                    html += '<tr><th>Мощность</th><td>' + escapeHtml(String(data.offer?.hashrate || '-')) + '</td></tr>';
                    html += '<tr><th>Продавец (телефон)</th><td>' + escapeHtml(String(data.offer?.sellerPhone || '-')) + '</td></tr>';
                    html += '<tr><th>Тип операции</th><td>' + escapeHtml(String(data.offer?.operationType || '-')) + '</td></tr>';
                    html += '<tr><th>Цена</th><td>' + escapeHtml(String(data.offer?.price ? data.offer.price + ' ' + (data.offer.currency || 'u') : '-')) + '</td></tr>';
                    html += '<tr><th>Количество</th><td>' + escapeHtml(String(data.offer?.quantity || '-')) + '</td></tr>';
                    html += '<tr><th>Состояние</th><td>' + escapeHtml(String(data.offer?.condition || '-')) + '</td></tr>';
                    html += '<tr><th>Локация</th><td>' + escapeHtml(String(data.offer?.location || '-')) + '</td></tr>';
                    html += '<tr><th>Примечание</th><td>' + escapeHtml(String(data.offer?.notes || '-')) + '</td></tr>';
                    html += '<tr><th>Дата создания</th><td>' + escapeHtml(String(data.offer?.createdAt || '-')) + '</td></tr>';
                    html += '<tr><th>Дата обновления</th><td>' + escapeHtml(String(data.offer?.updatedAt || '-')) + '</td></tr>';
                    html += '<tr><th>Источник (чат)</th><td>' + escapeHtml(String(data.offer?.sourceChatName || '-')) + '</td></tr>';
                    html += '</table></div>';
                    
                    if (data.sourceMessage) {
                        html += '<hr class="my-4"><h6 class="mb-3">Исходное сообщение из WhatsApp</h6>';
                        html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
                        html += '<tr><th class="w-25">ID сообщения</th><td>' + escapeHtml(String(data.sourceMessage.messageId || '-')) + '</td></tr>';
                        html += '<tr><th>Чат</th><td>' + escapeHtml(String(data.sourceMessage.chatName || '-')) + '</td></tr>';
                        html += '<tr><th>Тип чата</th><td>' + escapeHtml(String(data.sourceMessage.chatType || '-')) + '</td></tr>';
                        html += '<tr><th>Отправитель</th><td>' + escapeHtml(String(data.sourceMessage.senderName || '-')) + '</td></tr>';
                        html += '<tr><th>Телефон отправителя</th><td>' + escapeHtml(String(data.sourceMessage.senderPhoneNumber || '-')) + '</td></tr>';
                        html += '<tr><th>Дата сообщения</th><td>' + escapeHtml(String(data.sourceMessage.timestamp || '-')) + '</td></tr>';
                        html += '<tr><th>Текст сообщения</th><td><pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 4px;">' +
                                (data.sourceMessage.content ? escapeHtml(String(data.sourceMessage.content)) : '-') + '</pre></td></tr>';
                        if (data.sourceMessage.hasMedia) {
                            html += '<tr><th>Медиа</th><td>Да (тип: ' + escapeHtml(String(data.sourceMessage.messageType || '-')) + ')</td></tr>';
                        }
                        html += '</table></div>';
                    } else {
                        html += '<hr class="my-4"><div class="alert alert-warning">Исходное сообщение не найдено</div>';
                    }
                    
                    html += '</div>';
                    modalContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Ошибка при загрузке деталей предложения:', error);
                    modalContent.innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных: ' + escapeHtml(error.message) + '</div>';
                });
            }
            
            function escapeHtml(text) {
                if (!text) return '';
                return String(text)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
            
            // Обработчик клика на строку
            function setupRowClickHandlers() {
                const tbody = document.querySelector('#offersTable tbody');
                if (!tbody) return;
                
                if (tbody._offerClickHandler) {
                    tbody.removeEventListener('click', tbody._offerClickHandler);
                }
                
                tbody._offerClickHandler = function(e) {
                    const target = e.target;
                    
                    if (target.tagName === 'BUTTON' || 
                        target.tagName === 'A' || 
                        target.tagName === 'INPUT' ||
                        target.closest('button') || 
                        target.closest('a') ||
                        target.closest('input') ||
                        target.closest('.page-link') ||
                        target.closest('.manufacturer-btn') ||
                        target.closest('.operation-type-btn') ||
                        target.closest('.date-filter-btn') ||
                        target.closest('.series-filter-btn') ||
                        target.closest('.offer-checkbox')) {
                        return;
                    }
                    
                    const row = target.closest('.offer-row');
                    if (row) {
                        const offerId = row.dataset.offerId;
                        if (offerId) {
                            e.preventDefault();
                            e.stopPropagation();
                            showOfferDetails(offerId);
                        }
                    }
                };
                
                tbody.addEventListener('click', tbody._offerClickHandler, false);
            }
            
            // Инициализация
            generateDateButtons();
            
            document.querySelectorAll('.manufacturer-btn').forEach(btn => {
                btn.addEventListener('click', handleManufacturerClick);
            });
            
            document.querySelectorAll('.operation-type-btn').forEach(btn => {
                btn.addEventListener('click', handleOperationTypeClick);
            });
            
            const dateFilterContainer = document.getElementById('dateFilterContainer');
            if (dateFilterContainer) {
                dateFilterContainer.addEventListener('click', function(e) {
                    const dateBtn = e.target.closest('.date-filter-btn');
                    if (dateBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        handleDateFilterClick(e);
                    }
                });
            }
            
            const seriesFilterContainer = document.getElementById('seriesFilterButtonsContainer');
            if (seriesFilterContainer) {
                seriesFilterContainer.addEventListener('click', function(e) {
                    const seriesBtn = e.target.closest('.series-filter-btn');
                    if (seriesBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        handleSeriesClick(e);
                    }
                });
            }
            
            window.loadOffers = loadOffers;
            setupRowClickHandlers();
        });
        
        // Функция для переключения выбора всех чекбоксов
        window.toggleSelectAll = function(checkbox) {
            const checkboxes = document.querySelectorAll('.offer-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateDeleteButton();
        };
        
        // Функция для обновления состояния кнопки удаления
        window.updateDeleteButton = function() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (!deleteBtn) return;
            
            const checkedBoxes = document.querySelectorAll('.offer-checkbox:checked');
            deleteBtn.disabled = checkedBoxes.length === 0;
        };
        
        // Функция для удаления выбранных предложений
        window.deleteSelectedOffers = function() {
            const checkedBoxes = document.querySelectorAll('.offer-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Выберите предложения для удаления');
                return;
            }
            
            const offerIds = Array.from(checkedBoxes).map(cb => cb.dataset.offerId);
            const count = offerIds.length;
            
            if (!confirm(`Вы уверены, что хотите удалить ${count} предложение(й)?`)) {
                return;
            }
            
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fe fe-loader"></i> Удаление...';
            }
            
            fetch('/private/offers/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ offerIds: offerIds })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error('Ошибка удаления: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`Успешно удалено предложений: ${data.deletedCount}`);
                    // Перезагружаем текущую страницу
                    const page = (typeof window.currentPage !== 'undefined' && window.currentPage !== null) ? window.currentPage : 0;
                    if (typeof window.loadOffers === 'function') {
                        window.loadOffers(page);
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Ошибка удаления: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка при удалении предложений:', error);
                alert('Ошибка удаления: ' + error.message);
            })
            .finally(() => {
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fe fe-trash-2"></i> Удалить выбранные';
                }
            });
        }
    </script>

</body>
</html>
