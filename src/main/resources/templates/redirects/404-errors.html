<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ru" dir="ltr" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light" data-menu-styles="light" data-toggled="close">
<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>404 ошибки - MinerHive</title>
    <!-- Favicon -->
    <th:block th:replace="~{fragments/favicon :: favicon-tags}"></th:block>
    <link id="style" th:href="@{/bootstrap-theme/assets/libs/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/bootstrap-theme/assets/css/styles.min.css}" rel="stylesheet">
    <link th:href="@{/bootstrap-theme/assets/css/icons.css}" rel="stylesheet">
    <script th:inline="javascript">
        (function() {
            function ensureElements() {
                if (!document.querySelector('.horizontal-menu')) {
                    let headerCenter = document.querySelector('.main-header-center');
                    if (!headerCenter && document.querySelector('.header-content-left')) {
                        headerCenter = document.createElement('div');
                        headerCenter.className = 'main-header-center d-none d-lg-block';
                        headerCenter.style.display = 'none';
                        document.querySelector('.header-content-left').appendChild(headerCenter);
                    }
                    if (headerCenter) {
                        const horizontalMenu = document.createElement('nav');
                        horizontalMenu.className = 'horizontal-menu';
                        horizontalMenu.style.display = 'none';
                        headerCenter.appendChild(horizontalMenu);
                    }
                }
                if (!document.getElementById('loader')) {
                    const loader = document.createElement('div');
                    loader.id = 'loader';
                    loader.style.display = 'none';
                    if (document.body) document.body.insertBefore(loader, document.body.firstChild);
                }
                if (!document.getElementById('switcher-canvas')) {
                    const switcher = document.createElement('div');
                    switcher.className = 'offcanvas offcanvas-end';
                    switcher.id = 'switcher-canvas';
                    switcher.setAttribute('tabindex', '-1');
                    switcher.style.display = 'none';
                    if (document.body) document.body.appendChild(switcher);
                }
                if (!document.getElementById('header-sidebar')) {
                    const sidebar = document.createElement('div');
                    sidebar.className = 'offcanvas offcanvas-end';
                    sidebar.id = 'header-sidebar';
                    sidebar.setAttribute('tabindex', '-1');
                    sidebar.style.display = 'none';
                    if (document.body) document.body.appendChild(sidebar);
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', ensureElements);
            } else {
                ensureElements();
            }
            if (document.body) ensureElements();
        })();
    </script>
    
    <style>
        html, body {
            overflow-x: hidden !important;
            overflow-y: auto !important;
        }
    </style>
</head>
<body>
    <div id="loader" style="display: none;"><div class="spinner-border text-primary"></div></div>
    <div class="page">
        <header class="app-header">
            <div class="main-header-container container-fluid">
                <div class="header-content-left">
                    <div class="header-element">
                        <div class="horizontal-logo">
                            <a th:href="@{/}" class="header-logo">
                                <img th:src="@{/bootstrap-theme/assets/images/brand-logos/desktop-logo.png}" alt="logo" class="desktop-logo">
                            </a>
                        </div>
                    </div>
                    <div class="header-element">
                        <a class="sidemenu-toggle header-link" data-bs-toggle="sidebar"><i class="header-icon fe fe-align-left"></i></a>
                        <div class="main-header-center d-none d-lg-block" style="display: none !important;"><nav class="horizontal-menu"></nav></div>
                    </div>
                </div>
                <div class="header-content-right">
                    <div class="header-element headerProfile-dropdown">
                        <a href="javascript:void(0);" class="header-link dropdown-toggle" data-bs-toggle="dropdown"><i class="fe fe-user fs-20"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" th:href="@{/}">Главная</a></li>
                            <li><a class="dropdown-item" th:href="@{/logout}">Выход</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        <!-- Start::app-sidebar -->
        <aside class="app-sidebar sticky" id="sidebar">
            <!-- Start::main-sidebar-header -->
            <div class="main-sidebar-header">
                <a th:href="@{/}" class="header-logo">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/desktop-logo.png}" src="../assets/images/brand-logos/desktop-logo.png" alt="logo" class="desktop-logo">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/toggle-logo.png}" src="../assets/images/brand-logos/toggle-logo.png" alt="logo" class="toggle-logo">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/desktop-white.png}" src="../assets/images/brand-logos/desktop-white.png" alt="logo" class="desktop-white">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/toggle-white.png}" src="../assets/images/brand-logos/toggle-white.png" alt="logo" class="toggle-white">
                </a>
            </div>
            <!-- End::main-sidebar-header -->

            <!-- Start::main-sidebar -->
            <div class="main-sidebar" id="sidebar-scroll">
                <!-- Start::nav -->
                <nav class="main-menu-container nav nav-pills flex-column sub-open">
                    <div class="slide-left" id="slide-left">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191" width="24" height="24" viewBox="0 0 24 24"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"></path> </svg>
                    </div>
                    <ul class="main-menu">
                        <!-- Start::slide__category -->
                        <li class="slide__category"><span class="category-name">Главное</span></li>
                        <!-- End::slide__category -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M5 5h4v6H5zm10 8h4v6h-4zM5 17h4v2H5zM15 5h4v2h-4z" opacity=".3"/><path d="M3 13h8V3H3v10zm2-8h4v6H5V5zm8 16h8V11h-8v10zm2-8h4v6h-4v-6zM13 3v6h8V3h-8zm6 4h-4V5h4v2zM3 21h8v-6H3v6zm2-4h4v2H5v-2z"/></svg>
                                <span class="side-menu__label">Панель управления</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide__category -->
                        <li class="slide__category"><span class="category-name">Управление</span></li>
                        <!-- End::slide__category -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/private/messages}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                                <span class="side-menu__label">Сообщения</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/private/products/table}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 5H5v14h14V5zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" opacity=".3"/><path d="M3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2zm2 0h14v14H5V5zm2 5h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/></svg>
                                <span class="side-menu__label">Таблица товаров</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">
                            <a th:href="@{/private/offers}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24">
                                    <path d="M0 0h24v24H0V0z" fill="none"/>
                                    <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                                </svg>
                                <span class="side-menu__label">Предложения</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private/requests}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                                <span class="side-menu__label">Заявки</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private/miner-details}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                                <span class="side-menu__label">Детали майнеров</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private/profitability}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                <span class="side-menu__label">Калькулятор доходности</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide__category -->
                        <li class="slide__category" sec:authorize="hasRole('ADMIN')"><span class="category-name">Администрирование</span></li>
                        <!-- End::slide__category -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/private/users}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-3.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-3.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                <span class="side-menu__label">Пользователи</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/private/redirects}" class="side-menu__item active">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                <span class="side-menu__label">Управление редиректами</span>
                            </a>
                        </li>
                        <!-- End::slide -->
                    </ul>
                </nav>
                <!-- End::nav -->
            </div>
            <!-- End::main-sidebar -->
        </aside>
        <!-- End::app-sidebar -->
        <div class="main-content app-content">
            <div class="container-fluid">
                <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb">
                    <div class="my-auto">
                        <h5 class="page-title fs-21 mb-1">404 ошибки</h5>
                        <nav><ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a th:href="@{/}">Главная</a></li>
                            <li class="breadcrumb-item"><a th:href="@{/private}">Панель управления</a></li>
                            <li class="breadcrumb-item"><a th:href="@{/private/redirects}">Редиректы</a></li>
                            <li class="breadcrumb-item active">404 ошибки</li>
                        </ol></nav>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger" onclick="cleanupOldErrors()">
                            <i class="fe fe-trash-2 me-2"></i>Очистить старые (30 дней)
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header">
                                <div class="card-title">Список 404 ошибок</div>
                            </div>
                            <div class="card-body">
                                <div id="alertContainer"></div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>URL</th>
                                                <th>HTTP метод</th>
                                                <th>Количество</th>
                                                <th>Первый раз</th>
                                                <th>Последний раз</th>
                                                <th>IP адрес</th>
                                                <th>Referer</th>
                                                <th>Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:if="${errorsPage == null || errorsPage.content.isEmpty()}">
                                                <td colspan="9" class="text-center py-4 text-muted">404 ошибки отсутствуют</td>
                                            </tr>
                                            <tr th:each="error : ${errorsPage.content}" th:if="${errorsPage != null and !errorsPage.content.isEmpty()}">
                                                <td th:text="${error.id}"></td>
                                                <td><code th:text="${error.url}"></code></td>
                                                <td><span class="badge bg-secondary" th:text="${error.httpMethod ?: 'GET'}"></span></td>
                                                <td><span class="badge bg-warning" th:text="${error.count}"></span></td>
                                                <td th:text="${#temporals.format(error.firstOccurred, 'dd.MM.yyyy HH:mm')}"></td>
                                                <td th:text="${#temporals.format(error.lastOccurred, 'dd.MM.yyyy HH:mm')}"></td>
                                                <td th:text="${error.ipAddress ?: '-'}"></td>
                                                <td>
                                                    <span th:if="${error.referer}" th:text="${error.referer.length() > 50 ? error.referer.substring(0, 50) + '...' : error.referer}"></span>
                                                    <span th:unless="${error.referer}" class="text-muted">-</span>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-primary create-redirect-from-error-btn" 
                                                            th:data-url="${error.url}">
                                                        <i class="fe fe-arrow-right-left me-1"></i>Создать редирект
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Пагинация -->
                                <div th:if="${errorsPage != null && errorsPage.totalPages > 1}" class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        <span class="text-muted">Страница <span th:text="${errorsPage.number + 1}"></span> из <span th:text="${errorsPage.totalPages}"></span></span>
                                    </div>
                                    <nav>
                                        <ul class="pagination mb-0">
                                            <li class="page-item" th:classappend="${errorsPage.number == 0} ? 'disabled'">
                                                <a class="page-link" th:href="@{/private/redirects/404-errors(page=${errorsPage.number - 1})}">Предыдущая</a>
                                            </li>
                                            <li class="page-item" th:classappend="${errorsPage.number == errorsPage.totalPages - 1} ? 'disabled'">
                                                <a class="page-link" th:href="@{/private/redirects/404-errors(page=${errorsPage.number + 1})}">Следующая</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer mt-auto py-3 bg-white text-center">
            <div class="container">
                <span class="text-muted">© 2025 <a href="javascript:void(0);" class="text-dark fw-semibold">MinerHive</a>. Все права защищены.</span>
            </div>
        </footer>
    </div>

    <script th:src="@{/bootstrap-theme/assets/libs/@popperjs/core/umd/popper.min.js}"></script>
    <script th:src="@{/bootstrap-theme/assets/libs/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/bootstrap-theme/assets/js/defaultmenu.min.js}"></script>
    <script th:src="@{/bootstrap-theme/assets/js/main.js}"></script>
    <script>
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <span>${message}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function createRedirectFromError(fromUrl) {
            const toUrl = prompt('Введите новый URL для редиректа:', '/');
            if (!toUrl) {
                return;
            }

            fetch('/private/redirects/api/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fromUrl: fromUrl,
                    toUrl: toUrl,
                    redirectType: 301
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Редирект успешно создан', 'success');
                    setTimeout(() => window.location.href = '/private/redirects', 1000);
                } else {
                    showAlert(data.error || 'Ошибка при создании редиректа', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Ошибка при создании редиректа', 'danger');
            });
        }

        function cleanupOldErrors() {
            if (!confirm('Вы уверены, что хотите удалить 404 ошибки старше 30 дней?')) {
                return;
            }

            fetch('/private/redirects/api/404-errors/cleanup?days=30', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Старые ошибки успешно удалены', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert(data.error || 'Ошибка при очистке', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Ошибка при очистке', 'danger');
            });
        }

        // Обработчик для кнопок создания редиректа из ошибки
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.create-redirect-from-error-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const fromUrl = this.getAttribute('data-url');
                    createRedirectFromError(fromUrl);
                });
            });
        });
    </script>
</body>
</html>

