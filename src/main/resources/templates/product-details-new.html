<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru" class="color-two">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title -->
    <title th:text="'Майнер ' + ${product.model} + ' - Miners Shop'">Майнер - Miners Shop</title>
    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{/assets/images/logo/favicon.png}" href="assets/images/logo/favicon.png">

    <!-- Bootstrap -->
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}" href="assets/css/bootstrap.min.css">
    <!-- select 2 -->
    <link rel="stylesheet" th:href="@{/assets/css/select2.min.css}" href="assets/css/select2.min.css">
    <!-- Slick -->
    <link rel="stylesheet" th:href="@{/assets/css/slick.css}" href="assets/css/slick.css">
    <!-- jQuery UI -->
    <link rel="stylesheet" th:href="@{/assets/css/jquery-ui.css}" href="assets/css/jquery-ui.css">
    <!-- Main css -->
    <link rel="stylesheet" th:href="@{/assets/css/main.css}" href="assets/css/main.css">
    <!-- Custom styles для таблицы предложений -->
    <style>
        /* Деловой стиль таблицы предложений */
        .offers-table {
            font-size: 0.875rem;
            border-collapse: collapse;
            width: 100%;
        }
        
        .offers-table thead th {
            background-color: #2c3e50;
            color: #ffffff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            border: 1px solid #34495e;
            white-space: nowrap;
        }
        
        .offers-table tbody td {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            vertical-align: middle;
        }
        
        .offers-table tbody tr {
            height: 28px;
            transition: background-color 0.15s ease;
        }
        
        .offers-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .offers-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        
        .offers-table tbody tr:hover {
            background-color: #e8f4f8;
        }
        
        .offers-table thead tr th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .offers-table thead tr th.sortable:hover {
            background-color: #34495e;
        }
        
        .offers-table .badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            font-weight: 500;
        }
        
        .offers-table tbody td span {
            font-size: 0.875rem;
        }
        
        /* Компактные размеры для ячеек */
        .offers-table th,
        .offers-table td {
            line-height: 1.3;
        }
    </style>
</head> 
<body>
    
<!--==================== Preloader Start ====================-->
  <div class="preloader">
    <img th:src="@{/assets/images/icon/preloader.gif}" src="assets/images/icon/preloader.gif" alt="">
  </div>
<!--==================== Preloader End ====================-->

<!--==================== Overlay Start ====================-->
<div class="overlay"></div>
<!--==================== Overlay End ====================-->

<!--==================== Sidebar Overlay Start ====================-->
<div class="side-overlay"></div>
<!--==================== Sidebar Overlay End ====================-->

<!-- ==================== Scroll to Top Start ==================== -->
<div class="progress-wrap">
  <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
      <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
  </svg>
</div>
<!-- ==================== Scroll to Top End ==================== -->

<!-- ==================== Search Box Start ==================== -->
 <form action="#" class="search-box">
  <button type="button" class="search-box__close position-absolute inset-block-start-0 inset-inline-end-0 m-16 w-48 h-48 border border-gray-100 rounded-circle flex-center text-white hover-text-gray-800 hover-bg-white text-2xl transition-1">
    <i class="ph ph-x"></i>
  </button>
  <div class="container">
    <div class="position-relative">
      <input type="text" class="form-control py-16 px-24 text-xl rounded-pill pe-64" placeholder="Поиск майнеров...">
      <button type="submit" class="w-48 h-48 bg-main-two-600 rounded-circle flex-center text-xl text-white position-absolute top-50 translate-middle-y inset-inline-end-0 me-8">
        <i class="ph ph-magnifying-glass"></i>
      </button>
    </div>
  </div>
 </form>
<!-- ==================== Search Box End ==================== -->

<!-- ==================== Mobile Menu Start ==================== -->
<div class="mobile-menu scroll-sm d-lg-none d-block">
    <button type="button" class="close-button"> <i class="ph ph-x"></i> </button>
    <div class="mobile-menu__inner">
        <a th:href="@{/}" class="mobile-menu__logo">
            <img th:src="@{/assets/images/logo/logo.png}" src="assets/images/logo/logo.png" alt="Logo">
        </a>
        <div class="mobile-menu__menu">
            <!-- Nav Menu Start -->
<ul class="nav-menu flex-align nav-menu--mobile">
    <li class="nav-menu__item">
        <a th:href="@{/}" class="nav-menu__link">Главная</a>
    </li>
    <li class="nav-menu__item">
        <a th:href="@{/products}" class="nav-menu__link">Товары</a>
    </li>
    <li class="nav-menu__item">
        <a th:href="@{/messages}" class="nav-menu__link">Сообщения</a>
    </li>
    <li class="nav-menu__item">
        <a th:href="@{/requests}" class="nav-menu__link">Заявки</a>
    </li>
</ul>
<!-- Nav Menu End -->
        </div>
    </div>
</div>
<!-- ==================== Mobile Menu End ==================== -->

    <!-- ======================= Header Top Start ========================= -->
<div class="header-top bg-main-two-600 flex-between">
    <div class="container container-lg">
        <div class="flex-between flex-wrap gap-8">
            <ul class="flex-align flex-wrap d-none d-md-flex">
                <li class="border-right-item"><a href="#shipping" class="text-white text-sm hover-text-decoration-underline">О нас</a></li>
                <li class="border-right-item"><a href="#shipping" class="text-white text-sm hover-text-decoration-underline">Доставка</a></li>
                <li class="border-right-item"><a href="#shipping" class="text-white text-sm hover-text-decoration-underline">Возврат</a></li>
            </ul>
        <ul class="header-top__right flex-align flex-wrap">
                <li class="border-right-item">
                    <a th:href="@{/messages}" class="text-white text-sm py-8 flex-align gap-6"> 
                        <span class="icon text-md d-flex"> <i class="ph ph-chat-dots"></i> </span> 
                        <span class="hover-text-decoration-underline">Сообщения</span>
                    </a>
                </li>
                <li class="border-right-item">
                    <a th:href="@{/products}" class="text-white text-sm py-8 flex-align gap-6"> 
                        <span class="icon text-md d-flex"> <i class="ph ph-box"></i> </span> 
                        <span class="hover-text-decoration-underline">Товары</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
<!-- ======================= Header Top End ========================= -->

    <!-- ======================= Middle Header Two Start ========================= -->
<header class="header-middle style-two bg-color-neutral">
    <div class="container container-lg">
        <nav class="header-inner flex-between">
            <!-- Logo Start -->
            <div class="logo">
                <a th:href="@{/}" class="link">
                    <img th:src="@{/assets/images/logo/logo-two.png}" src="assets/images/logo/logo-two.png" alt="Logo">
                </a>
            </div>
            <!-- Logo End  -->

            <!-- form Category Start -->
            <div class="flex-align gap-16">
                <form action="#" class="flex-align flex-wrap form-location-wrapper">
                    <div class="search-category style-two d-flex h-48 search-form d-sm-flex d-none">
                        <div class="search-form__wrapper position-relative">
                            <input type="text" class="search-form__input common-input py-13 ps-16 pe-18 rounded-0 border-0" placeholder="Поиск майнеров...">
                        </div>
                        <button type="submit" class="bg-main-two-600 flex-center text-xl text-white flex-shrink-0 w-48 hover-bg-main-two-700 d-lg-flex d-none"><i class="ph ph-magnifying-glass"></i></button>
                    </div>
                </form>
            </div>
            <!-- form Category End -->
             
            <!-- Header Middle Right start -->
            <div class="header-right flex-align d-lg-block d-none">
                <div class="header-two-activities flex-align flex-wrap gap-32">
                    <button type="button" class="flex-align search-icon d-lg-none d-flex gap-4 item-hover-two">
                        <span class="text-2xl text-white d-flex position-relative item-hover__text">
                            <i class="ph ph-magnifying-glass"></i>
                        </span>
                    </button>
                    <a th:href="@{/messages}" class="flex-align flex-column gap-8 item-hover-two">
                        <span class="text-2xl text-white d-flex position-relative item-hover__text">
                            <i class="ph ph-chat-dots"></i>
                        </span>
                        <span class="text-md text-white item-hover__text d-none d-lg-flex">Сообщения</span>
                    </a>
                    <a th:href="@{/products}" class="flex-align flex-column gap-8 item-hover-two">
                        <span class="text-2xl text-white d-flex position-relative item-hover__text">
                            <i class="ph ph-box"></i>
                        </span>
                        <span class="text-md text-white item-hover__text d-none d-lg-flex">Товары</span>
                    </a>
                </div>
            </div>
            <!-- Header Middle Right End  -->
        </nav>
    </div>
</header>
<!-- ======================= Middle Header Two End ========================= -->

    <!-- ==================== Header Start ==================== -->
<header class="header bg-white border-bottom border-gray-100">
    <div class="container container-lg">
        <nav class="header-inner d-flex justify-content-between gap-8">
            <!-- Menu Start  -->
            <div class="header-menu d-lg-block d-none flex-grow-1">
                <!-- Nav Menu Start -->
<ul class="nav-menu flex-align">
    <li class="nav-menu__item">
        <a th:href="@{/}" class="nav-menu__link">Главная</a>
    </li>
    <li class="nav-menu__item">
        <a th:href="@{/products}" class="nav-menu__link">Товары</a>
    </li>
    <li class="nav-menu__item">
        <a th:href="@{/messages}" class="nav-menu__link">Сообщения</a>
    </li>
    <li class="nav-menu__item">
        <a th:href="@{/requests}" class="nav-menu__link">Заявки</a>
    </li>
</ul>
<!-- Nav Menu End -->
            </div>
        </nav>
    </div>
</header>
<!-- ==================== Header End ==================== -->

    <!-- ========================= Breadcrumb Start =============================== -->
<div class="breadcrumb py-26 bg-main-two-50">
    <div class="container container-lg">
        <div class="breadcrumb-wrapper flex-between flex-wrap gap-16">
            <h6 class="mb-0">Детали товара</h6>
            <ul class="flex-align gap-8 flex-wrap">
                <li class="text-sm">
                    <a th:href="@{/}" class="text-gray-900 flex-align gap-8 hover-text-main-two-600">
                        <i class="ph ph-house"></i>
                        Главная
                    </a>
                </li>
                <li class="flex-align">
                    <i class="ph ph-caret-right"></i>
                </li>
                <li class="text-sm">
                    <a th:href="@{/products}" class="text-gray-900 flex-align gap-8 hover-text-main-two-600">
                        Товары
                    </a>
                </li>
                <li class="flex-align">
                    <i class="ph ph-caret-right"></i>
                </li>
                <li class="text-sm">
                    <a th:href="@{/products/table}" class="text-gray-900 flex-align gap-8 hover-text-main-two-600">
                        Таблица товаров
                    </a>
                </li>
                <li class="flex-align">
                    <i class="ph ph-caret-right"></i>
                </li>
                <li class="text-sm text-main-two-600" th:utext="${product.model}">Модель майнера</li>
            </ul>
        </div>
    </div>
</div>
<!-- ========================= Breadcrumb End =============================== -->

    <!-- ========================== Product Details Two Start =========================== -->
<section class="product-details py-80">
    <div class="container container-lg">
        <div class="row gy-4">
            <div class="col-xl-12">
                <div class="row gy-4">
                    <div class="col-xl-6">
                        <div class="product-details__left">
                            
                            <!-- Главное изображение товара -->
                            <div class="product-details__thumb-slider border border-gray-100 rounded-16">
                                <div class="">
                                    <div class="product-details__thumb flex-center h-100">
                                        <img th:if="${product.imageUrl != null && !#strings.isEmpty(product.imageUrl)}" 
                                             th:src="@{${product.imageUrl}}" 
                                             th:alt="${product.model}"
                                             alt="Майнер"
                                             style="max-width: 100%; max-height: 500px; object-fit: contain; padding: 20px;"
                                             onerror="this.onerror=null; this.src='/assets/images/thumbs/product-img1.png';">
                                        <div th:unless="${product.imageUrl != null && !#strings.isEmpty(product.imageUrl)}" 
                                             class="flex-center h-100 flex-column text-gray-400">
                                            <i class="ph ph-image text-6xl mb-16"></i>
                                            <p class="text-sm">Фото товара</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Миниатюры (если есть несколько изображений, можно добавить в будущем) -->
                            <div class="mt-24" th:if="${product.imageUrl != null && !#strings.isEmpty(product.imageUrl)}">
                                <div class="product-details__images-slider">
                                    <div>
                                        <div class="max-w-120 max-h-120 h-100 flex-center border border-gray-100 rounded-16 p-8">
                                            <img th:src="@{${product.imageUrl}}" th:alt="${product.model}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="product-details__content">
                            
                            <!-- Бейдж типа операции -->
                            <div class="mb-24" th:if="${!#lists.isEmpty(sellOffers) || !#lists.isEmpty(buyOffers)}">
                                <div class="flex-align gap-16 flex-wrap">
                                    <span th:if="${!#lists.isEmpty(sellOffers) && #lists.isEmpty(buyOffers)}" 
                                          class="badge bg-success text-white px-16 py-8 rounded-8">
                                        <i class="ph ph-arrow-down-circle"></i> Продажа
                                    </span>
                                    <span th:if="${#lists.isEmpty(sellOffers) && !#lists.isEmpty(buyOffers)}" 
                                          class="badge bg-info text-white px-16 py-8 rounded-8">
                                        <i class="ph ph-arrow-up-circle"></i> Покупка
                                    </span>
                                    <span th:if="${!#lists.isEmpty(sellOffers) && !#lists.isEmpty(buyOffers)}" 
                                          class="badge bg-warning text-dark px-16 py-8 rounded-8">
                                        <i class="ph ph-arrow-left-right"></i> Продажа/Покупка
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Название товара -->
                            <h5 class="mb-12" th:utext="${product.model}">Модель майнера</h5>
                            
                            <!-- Количество предложений -->
                            <div class="flex-align flex-wrap gap-12 mb-24">
                                <span class="text-gray-900">
                                    <span class="text-gray-400">Предложений:</span>
                                    <span class="fw-medium" th:text="${offersPage != null ? offersPage.totalElements : 0}">0</span>
                                </span>
                                <span class="text-sm fw-medium text-gray-500">|</span>
                                <span class="text-gray-900">
                                    <span class="text-gray-400">Продажи:</span>
                                    <span class="badge bg-success" th:text="${#lists.size(sellOffers)}">0</span>
                                </span>
                                <span class="text-gray-900">
                                    <span class="text-gray-400">Покупки:</span>
                                    <span class="badge bg-info" th:text="${#lists.size(buyOffers)}">0</span>
                                </span>
                            </div>
                            
                            <span class="mt-32 pt-32 text-gray-700 border-top border-gray-100 d-block"></span>
                            
                            <!-- Описание товара -->
                            <p class="text-gray-700 mt-24" th:if="${product.description != null && !#strings.isEmpty(product.description)}" th:utext="${product.description}">
                                Описание товара
                            </p>
                            <p class="text-gray-500 mt-24" th:unless="${product.description != null && !#strings.isEmpty(product.description)}">
                                Описание не указано
                            </p>

                            <!-- Цена -->
                            <div class="my-32 flex-align gap-16 flex-wrap" th:if="${minPrice != null}">
                                <div class="flex-align gap-8">
                                    <h6 class="mb-0 text-main-two-600" th:text="${#numbers.formatDecimal(minPrice, 0, 'COMMA', 0, 'POINT') + ' ' + currency}">Цена</h6>
                                </div>
                                <div class="flex-align gap-8">
                                    <span class="text-gray-700">Цена от</span>
                                </div>
                            </div>
                            <div class="my-32" th:unless="${minPrice != null}">
                                <span class="text-gray-500">Цена не указана</span>
                            </div>
                            
                            <span class="mt-32 pt-32 text-gray-700 border-top border-gray-100 d-block"></span>

                            <!-- Краткая информация -->
                            <div class="mt-32">
                                <h6 class="mb-16">Краткая информация</h6>
                                <ul class="mt-16">
                                    <li class="text-gray-700 mb-12 flex-align gap-12">
                                        <span class="w-20 h-20 bg-main-two-50 text-main-two-600 text-xs flex-center rounded-circle">
                                            <i class="ph ph-check"></i>
                                        </span>
                                        <span class="text-heading fw-medium">
                                            Модель:
                                            <span class="text-gray-500" th:utext="${product.model}">Модель</span>
                                        </span>
                                    </li>
                                    <li class="text-gray-700 mb-12 flex-align gap-12" th:if="${offersPage != null && offersPage.totalElements > 0}">
                                        <span class="w-20 h-20 bg-main-two-50 text-main-two-600 text-xs flex-center rounded-circle">
                                            <i class="ph ph-check"></i>
                                        </span>
                                        <span class="text-heading fw-medium">
                                            Предложений:
                                            <span class="text-gray-500" th:text="${offersPage != null ? offersPage.totalElements : 0}">0</span>
                                        </span>
                                    </li>
                                    <li class="text-gray-700 mb-12 flex-align gap-12" th:if="${product.createdAt != null}">
                                        <span class="w-20 h-20 bg-main-two-50 text-main-two-600 text-xs flex-center rounded-circle">
                                            <i class="ph ph-check"></i>
                                        </span>
                                        <span class="text-heading fw-medium">
                                            Дата создания:
                                            <span class="text-gray-500" th:text="${#temporals.format(product.createdAt, 'dd.MM.yyyy')}">Дата</span>
                                        </span>
                                    </li>
                                </ul>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Блок с таблицей предложений -->
        <div class="pt-80" th:if="${offersPage != null && offersPage.totalElements > 0}">
            <div class="border rounded-24 p-32">
                <div class="flex-between flex-wrap gap-16 mb-24">
                    <div class="flex-align gap-8 flex-wrap">
                        <h6 class="mb-0 fw-semibold">Предложения по данному товару</h6>
                        <a th:href="@{/products/table}" class="btn btn-sm btn-outline-main-two flex-align gap-6" style="padding: 4px 12px; font-size: 0.875rem;">
                            <i class="ph ph-table"></i>
                            <span>Таблица товаров</span>
                        </a>
                    </div>
                    
                    <!-- Фильтры по дате -->
                    <div class="flex-align gap-8 flex-wrap date-filters">
                        <button type="button" 
                                class="btn btn-sm date-filter-btn" 
                                data-filter="today"
                                th:classappend="${dateFilter == 'today'} ? 'btn-main-two' : 'btn-outline-main-two'"
                                style="padding: 6px 12px; font-size: 0.875rem;">
                            Сегодня
                        </button>
                        <button type="button" 
                                class="btn btn-sm date-filter-btn" 
                                data-filter="3days"
                                th:classappend="${dateFilter == '3days'} ? 'btn-main-two' : 'btn-outline-main-two'"
                                style="padding: 6px 12px; font-size: 0.875rem;">
                            3 дня
                        </button>
                        <button type="button" 
                                class="btn btn-sm date-filter-btn" 
                                data-filter="week"
                                th:classappend="${dateFilter == 'week'} ? 'btn-main-two' : 'btn-outline-main-two'"
                                style="padding: 6px 12px; font-size: 0.875rem;">
                            Неделя
                        </button>
                        <button type="button" 
                                class="btn btn-sm date-filter-btn" 
                                data-filter="month"
                                th:classappend="${dateFilter == 'month'} ? 'btn-main-two' : 'btn-outline-main-two'"
                                style="padding: 6px 12px; font-size: 0.875rem;">
                            Месяц
                        </button>
                        <button type="button" 
                                class="btn btn-sm date-filter-btn" 
                                data-filter=""
                                th:classappend="${dateFilter == '' || dateFilter == null} ? 'btn-main-two' : 'btn-outline-main-two'"
                                style="padding: 6px 12px; font-size: 0.875rem;">
                            Все
                        </button>
                    </div>
                </div>
                
                <!-- Дополнительные фильтры - перенесены влево к краю таблицы, уменьшены в 3 раза, в цвете сайта -->
                <div class="flex-align gap-3 flex-wrap additional-filters mb-16" style="align-items: flex-start;">
                    <button type="button" 
                            class="btn btn-outline-main-two operation-filter-btn" 
                            data-operation="SELL"
                            style="padding: 3px 8px; font-size: 0.6rem; line-height: 1.3; min-height: auto; border-width: 1px; white-space: nowrap;">
                        Продажа
                    </button>
                    <button type="button" 
                            class="btn btn-outline-main-two operation-filter-btn" 
                            data-operation="BUY"
                            style="padding: 3px 8px; font-size: 0.6rem; line-height: 1.3; min-height: auto; border-width: 1px; white-space: nowrap;">
                        Покупка
                    </button>
                    <button type="button" 
                            class="btn btn-outline-main-two has-price-filter-btn" 
                            data-has-price="true"
                            style="padding: 3px 8px; font-size: 0.6rem; line-height: 1.3; min-height: auto; border-width: 1px; white-space: nowrap;">
                        Без пустых цен
                    </button>
                </div>
                
                <!-- Выбор количества записей на странице -->
                <div class="flex-between flex-wrap gap-16 mb-16">
                    <div class="flex-align gap-8">
                        <span class="text-sm text-gray-600">Показать:</span>
                        <select id="pageSizeSelect" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                            <option th:value="10" th:selected="${pageSize == 10 || pageSize == null}">10</option>
                            <option th:value="20" th:selected="${pageSize == 20}">20</option>
                            <option th:value="50" th:selected="${pageSize == 50}">50</option>
                            <option th:value="100" th:selected="${pageSize == 100}">100</option>
                        </select>
                        <span class="text-sm text-gray-600">записей</span>
                    </div>
                    <div class="text-sm text-gray-600" id="recordsInfo" th:if="${offersPage != null}">
                        Показано <span th:text="${offersPage.number * offersPage.size + 1}">1</span> - 
                        <span th:text="${offersPage.number * offersPage.size + #lists.size(offersPage.content)}">0</span> из 
                        <span th:text="${offersPage.totalElements}">0</span>
                    </div>
                </div>
                
                <!-- Таблица предложений -->
                <div class="table-responsive">
                    <table class="offers-table" id="offersTable">
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-sort="operationType" data-column="0">
                                                    Тип
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="hashrate" data-column="1">
                                                    Хэшрейт
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="quantity" data-column="2">
                                                    Кол-во
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="price" data-column="3">
                                                    Цена
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="condition" data-column="4">
                                                    Состояние
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="location" data-column="5">
                                                    Локация
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="notes" data-column="6">
                                                    Примечания
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="updatedAt" data-column="7">
                                                    Дата
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th style="width: 150px;">Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody id="offersTableBody">
                                            <!-- Начальные данные загружаются из сервера -->
                                            <tr th:each="offer : ${offersPage != null ? offersPage.content : #lists.list()}">
                                                <td>
                                                    <span th:if="${offer.operationType != null && offer.operationType.name() == 'SELL'}" 
                                                          class="badge bg-success">Продажа</span>
                                                    <span th:if="${offer.operationType != null && offer.operationType.name() == 'BUY'}" 
                                                          class="badge bg-info">Покупка</span>
                                                    <span th:if="${offer.operationType == null}" 
                                                          class="badge bg-secondary">Не указано</span>
                                                </td>
                                                <td>
                                                    <span th:if="${offer.hashrate != null && !offer.hashrate.isEmpty()}" 
                                                          th:utext="${offer.hashrate}">-</span>
                                                    <span th:if="${offer.hashrate == null || offer.hashrate.isEmpty()}" 
                                                          class="text-gray-400">-</span>
                                                </td>
                                                <td th:text="${offer.quantity != null ? offer.quantity + ' шт.' : '-'}">-</td>
                                                <td>
                                                    <span th:if="${offer.price != null}" 
                                                          th:classappend="${offer.operationType != null && offer.operationType.name() == 'BUY'} ? 'text-info fw-bold' : 'text-success fw-bold'">
                                                        <span th:text="${offer.price}"></span>
                                                        <span th:if="${offer.currency != null and !offer.currency.isEmpty()}" th:utext="' ' + ${offer.currency}"></span>
                                                    </span>
                                                    <span th:if="${offer.price == null}" class="text-gray-400">-</span>
                                                </td>
                                                <td>
                                                    <span th:if="${offer.condition != null && !offer.condition.isEmpty()}" 
                                                          th:utext="${offer.condition}">-</span>
                                                    <span th:if="${offer.condition == null || offer.condition.isEmpty()}" 
                                                          class="text-gray-400">-</span>
                                                </td>
                                                <td>
                                                    <span th:if="${offer.location != null && !offer.location.isEmpty()}" 
                                                          th:utext="${offer.location}">-</span>
                                                    <span th:if="${offer.location == null || offer.location.isEmpty()}" 
                                                          class="text-gray-400">-</span>
                                                </td>
                                                <td style="max-width: 200px;">
                                                    <span th:if="${offer.notes != null && !offer.notes.isEmpty()}" 
                                                          class="text-muted small" 
                                                          th:utext="${offer.notes}"
                                                          style="word-wrap: break-word; display: block;">Примечания</span>
                                                    <span th:if="${offer.notes == null || offer.notes.isEmpty()}" 
                                                          class="text-gray-400">-</span>
                                                </td>
                                                <td th:text="${#temporals.format(offer.updatedAt, 'dd.MM.yyyy HH:mm')}">Дата</td>
                                                <td>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-main-two" 
                                                            th:attr="data-offer-id=${offer.id}"
                                                            onclick="openRequestModal(this.getAttribute('data-offer-id'))"
                                                            style="white-space: nowrap; padding: 4px 8px; font-size: 0.75rem;">
                                                        <i class="ph ph-paper-plane-tilt"></i> <span>Заявка</span>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                    </table>
                </div>
                
                <!-- Пагинация -->
                <div class="mt-24" id="paginationContainer" style="display: none;">
                    <nav>
                        <ul class="pagination justify-content-center mb-0" id="paginationList">
                            <!-- Пагинация будет обновляться через JavaScript -->
                            <th:block th:if="${offersPage != null && offersPage.totalPages > 1}">
                                <li class="page-item" th:classappend="${offersPage.first} ? 'disabled' : ''">
                                    <a class="page-link" href="#" th:attr="data-page=${offersPage.number - 1}">Предыдущая</a>
                                </li>
                                <li th:each="pageNum : ${#numbers.sequence(0, offersPage.totalPages - 1)}"
                                    class="page-item" th:classappend="${pageNum == offersPage.number} ? 'active' : ''">
                                    <a class="page-link" href="#" th:attr="data-page=${pageNum}" th:text="${pageNum + 1}">1</a>
                                </li>
                                <li class="page-item" th:classappend="${offersPage.last} ? 'disabled' : ''">
                                    <a class="page-link" href="#" th:attr="data-page=${offersPage.number + 1}">Следующая</a>
                                </li>
                            </th:block>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Пустое состояние для предложений -->
        <div class="pt-80 text-center py-80" th:if="${offersPage == null || offersPage.totalElements == 0}">
            <div class="border rounded-24 p-32">
                <div class="w-120 h-120 bg-gray-100 rounded-circle flex-center mx-auto mb-24">
                    <i class="ph ph-inbox text-gray-400" style="font-size: 3rem;"></i>
                </div>
                <h5 class="text-gray-600 mb-8">Предложений пока нет</h5>
                <p class="text-gray-500">Предложения появятся автоматически после обработки сообщений из WhatsApp</p>
            </div>
        </div>

        <!-- Табы с описанием -->
        <div class="pt-80">
            <div class="product-dContent border rounded-24">
                <div class="product-dContent__header border-bottom border-gray-100 flex-between flex-wrap gap-16">
                    <ul class="nav common-tab nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                          <button class="nav-link active" id="pills-description-tab" data-bs-toggle="pill" data-bs-target="#pills-description" type="button" role="tab" aria-controls="pills-description" aria-selected="true">Описание</button>
                        </li>
                    </ul>
                </div>
                <div class="product-dContent__box">
                    <div class="tab-content" id="pills-tabContent">
                        <!-- Tab Описание -->
                        <div class="tab-pane fade show active" id="pills-description" role="tabpanel" aria-labelledby="pills-description-tab" tabindex="0">
                            <div class="mb-40">
                                <h6 class="mb-24">Описание товара</h6>
                                <p th:if="${product.description != null && !#strings.isEmpty(product.description)}" th:utext="${product.description}">
                                    Описание товара
                                </p>
                                <p th:unless="${product.description != null && !#strings.isEmpty(product.description)}" class="text-gray-500">
                                    Описание не указано
                                </p>
                            </div>
                            <div class="mb-40">
                                <h6 class="mb-24">Характеристики</h6>
                                <ul class="mt-32">
                                    <li class="text-gray-400 mb-14 flex-align gap-14">
                                        <span class="w-20 h-20 bg-main-two-50 text-main-two-600 text-xs flex-center rounded-circle">
                                            <i class="ph ph-check"></i>
                                        </span>
                                        <span class="text-heading fw-medium">
                                            Модель:
                                            <span class="text-gray-500" th:utext="${product.model}">Модель</span>
                                        </span>
                                    </li>
                                    <li class="text-gray-400 mb-14 flex-align gap-14">
                                        <span class="w-20 h-20 bg-main-two-50 text-main-two-600 text-xs flex-center rounded-circle">
                                            <i class="ph ph-check"></i>
                                        </span>
                                        <span class="text-heading fw-medium">
                                            Количество предложений:
                                            <span class="text-gray-500" th:text="${offersPage != null ? offersPage.totalElements : 0}">0</span>
                                        </span>
                                    </li>
                                    <li class="text-gray-400 mb-14 flex-align gap-14" th:if="${product.createdAt != null}">
                                        <span class="w-20 h-20 bg-main-two-50 text-main-two-600 text-xs flex-center rounded-circle">
                                            <i class="ph ph-check"></i>
                                        </span>
                                        <span class="text-heading fw-medium">
                                            Дата создания:
                                            <span class="text-gray-500" th:text="${#temporals.format(product.createdAt, 'dd.MM.yyyy HH:mm')}">Дата</span>
                                        </span>
                                    </li>
                                    <li class="text-gray-400 mb-14 flex-align gap-14" th:if="${product.updatedAt != null}">
                                        <span class="w-20 h-20 bg-main-two-50 text-main-two-600 text-xs flex-center rounded-circle">
                                            <i class="ph ph-check"></i>
                                        </span>
                                        <span class="text-heading fw-medium">
                                            Последнее обновление:
                                            <span class="text-gray-500" th:text="${#temporals.format(product.updatedAt, 'dd.MM.yyyy HH:mm')}">Дата</span>
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- ========================== Product Details Two End =========================== -->

<!-- ==================== Footer Start ==================== -->
<footer class="footer bg-color-one pt-80 pb-40">
    <div class="container container-lg">
        <div class="footer__inner">
            <div class="row gy-4">
                <div class="col-xl-3 col-md-6 col-sm-6">
                    <div class="footer__item">
                        <div class="footer__logo mb-24">
                            <a th:href="@{/}">
                                <img th:src="@{/assets/images/logo/logo.png}" src="assets/images/logo/logo.png" alt="Logo">
                            </a>
                        </div>
                        <p class="text-gray-600">Интернет-магазин майнеров с автоматическим обновлением ассортимента из WhatsApp</p>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-sm-6">
                    <div class="footer__item">
                        <h6 class="footer__title mb-24">Быстрые ссылки</h6>
                        <ul class="footer__list">
                            <li><a th:href="@{/}" class="text-gray-600 hover-text-main-two-600">Главная</a></li>
                            <li><a th:href="@{/products}" class="text-gray-600 hover-text-main-two-600">Товары</a></li>
                            <li><a th:href="@{/messages}" class="text-gray-600 hover-text-main-two-600">Сообщения</a></li>
                            <li><a th:href="@{/requests}" class="text-gray-600 hover-text-main-two-600">Заявки</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-sm-6">
                    <div class="footer__item">
                        <h6 class="footer__title mb-24">Информация</h6>
                        <ul class="footer__list">
                            <li><a href="#" class="text-gray-600 hover-text-main-two-600">О нас</a></li>
                            <li><a href="#" class="text-gray-600 hover-text-main-two-600">Доставка</a></li>
                            <li><a href="#" class="text-gray-600 hover-text-main-two-600">Возврат</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-sm-6">
                    <div class="footer__item">
                        <h6 class="footer__title mb-24">Контакты</h6>
                        <ul class="footer__list">
                            <li class="text-gray-600">Email: info@minersshop.ru</li>
                            <li class="text-gray-600">Телефон: +7 (XXX) XXX-XX-XX</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- bottom Footer -->
<div class="bottom-footer bg-color-one py-8">
    <div class="container container-lg">
        <div class="bottom-footer__inner flex-between flex-wrap gap-16 py-16">
            <p class="bottom-footer__text">Miners Shop &copy; 2024. Все права защищены</p>
        </div>
    </div>
</div>
<!-- ==================== Footer End ==================== -->
  

    
    <!-- jQuery js -->
    <script th:src="@{/assets/js/jquery-3.7.1.min.js}" src="assets/js/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap Bundle Js -->
    <script th:src="@{/assets/js/boostrap.bundle.min.js}" src="assets/js/boostrap.bundle.min.js"></script>
    <!-- Phosphor Icons -->
    <script th:src="@{/assets/js/phosphor-icon.js}" src="assets/js/phosphor-icon.js"></script>
    <!-- Select 2 -->
    <script th:src="@{/assets/js/select2.min.js}" src="assets/js/select2.min.js"></script>
    <!-- Slick js -->
    <script th:src="@{/assets/js/slick.min.js}" src="assets/js/slick.min.js"></script>
    <!-- jQuery UI -->
    <script th:src="@{/assets/js/jquery-ui.js}" src="assets/js/jquery-ui.js"></script>
    <!-- Main js -->
    <script th:src="@{/assets/js/main.js}" src="assets/js/main.js"></script>
    
    <!-- JavaScript для сортировки и фильтрации через AJAX -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Глобальные переменные для состояния таблицы
        const productId = /*[[${product.id}]]*/ null;
        let currentDateFilter = /*[[${dateFilter != null ? dateFilter : ''}]]*/ '';
        let currentOperationType = null; // SELL, BUY или null для всех
        let currentHasPrice = null; // true для фильтра "Без пустых цен", null для всех
        let currentSortBy = /*[[${sortBy}]]*/ 'updatedAt';
        let currentSortDir = /*[[${sortDir}]]*/ 'DESC';
        let currentPage = /*[[${currentPage}]]*/ 0;
        let currentPageSize = /*[[${pageSize != null ? pageSize : 10}]]*/ 10; // По умолчанию 10 записей
        
        // Функция форматирования даты
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            // Парсим дату из строки (может быть в формате ISO 8601 или массива)
            let date = null;
            try {
                if (typeof dateString === 'string') {
                    // Если строка содержит массив чисел [год, месяц, день, час, минута, секунда]
                    if (dateString.startsWith('[') || dateString.includes(',')) {
                        try {
                            const parts = JSON.parse(dateString);
                            if (Array.isArray(parts) && parts.length >= 6) {
                                // Массив: [year, month, day, hour, minute, second]
                                date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4], parts[5] || 0);
                            } else {
                                date = new Date(dateString);
                            }
                        } catch (e) {
                            date = new Date(dateString);
                        }
                    } else {
                        date = new Date(dateString);
                    }
                } else if (Array.isArray(dateString)) {
                    // Если это уже массив
                    if (dateString.length >= 6) {
                        date = new Date(dateString[0], dateString[1] - 1, dateString[2], dateString[3], dateString[4], dateString[5] || 0);
                    } else {
                        return '-';
                    }
                } else {
                    date = new Date(dateString);
                }
                
                // Проверяем, что дата валидна
                if (!date || isNaN(date.getTime())) {
                    console.warn('Невалидная дата:', dateString);
                    return '-';
                }
                
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}.${month}.${year} ${hours}:${minutes}`;
            } catch (e) {
                console.warn('Ошибка при форматировании даты:', e, dateString);
                return '-';
            }
        }
        
        // Функция загрузки предложений через AJAX
        function loadOffers() {
            // Убеждаемся, что параметры сортировки установлены
            if (!currentSortBy) {
                currentSortBy = 'updatedAt';
            }
            if (!currentSortDir) {
                currentSortDir = 'DESC';
            }
            
            // Формируем URL с учетом всех фильтров
            const params = new URLSearchParams();
            if (currentDateFilter) params.append('dateFilter', currentDateFilter);
            if (currentOperationType) params.append('operationType', currentOperationType);
            if (currentHasPrice === true) params.append('hasPrice', 'true');
            params.append('sortBy', currentSortBy);
            params.append('sortDir', currentSortDir);
            params.append('page', currentPage);
            params.append('size', currentPageSize);
            
            const url = `/api/products/${productId}/offers?${params.toString()}`;
            
            console.log('Загрузка предложений:', {
                dateFilter: currentDateFilter,
                operationType: currentOperationType,
                hasPrice: currentHasPrice,
                sortBy: currentSortBy,
                sortDir: currentSortDir,
                page: currentPage,
                size: currentPageSize,
                url: url
            });
            
            // Показываем индикатор загрузки
            const tableBody = document.getElementById('offersTableBody');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-32"><div class="spinner-border text-main-two-600" role="status"><span class="visually-hidden">Загрузка...</span></div></td></tr>';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-32 text-danger">Ошибка: ${data.error}</td></tr>`;
                        return;
                    }
                    
                    // Обновляем таблицу
                    updateTable(data.content);
                    
                    // Обновляем информацию о количестве записей
                    updateRecordsInfo(data);
                    
                    // Обновляем пагинацию
                    updatePagination(data);
                    
                    // Обновляем иконки сортировки
                    updateSortIcons();
                    
                    // Обновляем активные кнопки фильтров
                    updateFilterButtons();
                })
                .catch(error => {
                    console.error('Ошибка при загрузке предложений:', error);
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-32 text-danger">Ошибка при загрузке данных</td></tr>';
                });
        }
        
        // Функция обновления таблицы
        function updateTable(offers) {
            const tableBody = document.getElementById('offersTableBody');
            
            if (!offers || offers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-32 text-gray-500">Предложений не найдено</td></tr>';
                return;
            }
            
            let html = '';
            offers.forEach(offer => {
                const operationType = offer.operationType || '';
                const operationBadge = operationType === 'SELL' ? 
                    '<span class="badge bg-success">Продажа</span>' : 
                    operationType === 'BUY' ? 
                    '<span class="badge bg-info">Покупка</span>' : 
                    '<span class="badge bg-secondary">Не указано</span>';
                
                const hashrate = offer.hashrate ? escapeHtml(offer.hashrate) : '<span class="text-gray-400">-</span>';
                const quantity = offer.quantity ? `${offer.quantity} шт.` : '-';
                const price = offer.price ? 
                    `<span class="${operationType === 'BUY' ? 'text-info' : 'text-success'} fw-bold">${offer.price}${offer.currency ? ' ' + escapeHtml(offer.currency) : ''}</span>` : 
                    '<span class="text-gray-400">-</span>';
                const condition = offer.condition ? escapeHtml(offer.condition) : '<span class="text-gray-400">-</span>';
                const location = offer.location ? escapeHtml(offer.location) : '<span class="text-gray-400">-</span>';
                const notes = offer.notes ? 
                    `<span class="text-muted small" style="word-wrap: break-word; display: block;">${escapeHtml(offer.notes)}</span>` : 
                    '<span class="text-gray-400">-</span>';
                // Обрабатываем дату: может быть строкой ISO 8601, массивом [year, month, day, hour, minute, second] или null
                let dateStr = '-';
                if (offer.updatedAt) {
                    try {
                        if (Array.isArray(offer.updatedAt)) {
                            // Если это массив [year, month, day, hour, minute, second, nano]
                            const parts = offer.updatedAt;
                            if (parts.length >= 6) {
                                const date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4], parts[5] || 0);
                                if (!isNaN(date.getTime())) {
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const year = date.getFullYear();
                                    const hours = String(date.getHours()).padStart(2, '0');
                                    const minutes = String(date.getMinutes()).padStart(2, '0');
                                    dateStr = `${day}.${month}.${year} ${hours}:${minutes}`;
                                }
                            }
                        } else if (typeof offer.updatedAt === 'string') {
                            // Если это строка
                            dateStr = formatDate(offer.updatedAt);
                        } else {
                            // Пытаемся преобразовать в строку и парсить
                            dateStr = formatDate(String(offer.updatedAt));
                        }
                    } catch (e) {
                        console.warn('Ошибка при форматировании даты:', e, offer.updatedAt);
                        dateStr = '-';
                    }
                }
                
                html += `
                    <tr>
                        <td>${operationBadge}</td>
                        <td>${hashrate}</td>
                        <td>${quantity}</td>
                        <td>${price}</td>
                        <td>${condition}</td>
                        <td>${location}</td>
                        <td style="max-width: 200px;">${notes}</td>
                        <td>${dateStr}</td>
                        <td>
                            <button type="button" 
                                    class="btn btn-sm btn-main-two" 
                                    data-offer-id="${offer.id}"
                                    onclick="openRequestModal(this.getAttribute('data-offer-id'))"
                                    style="white-space: nowrap; padding: 4px 8px; font-size: 0.75rem;">
                                <i class="ph ph-paper-plane-tilt"></i> <span>Заявка</span>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // Функция экранирования HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        
        // Функция обновления информации о записях
        function updateRecordsInfo(data) {
            const infoElement = document.getElementById('recordsInfo');
            if (infoElement && data) {
                const start = data.currentPage * data.pageSize + 1;
                const end = data.currentPage * data.pageSize + data.numberOfElements;
                infoElement.innerHTML = `Показано ${start} - ${end} из ${data.totalElements}`;
            }
        }
        
        // Функция обновления пагинации
        function updatePagination(data) {
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationList = document.getElementById('paginationList');
            
            // Проверяем существование элементов
            if (!paginationContainer || !paginationList) {
                console.warn('Элементы пагинации не найдены на странице');
                return;
            }
            
            if (!data || data.totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            
            let html = '';
            
            // Кнопка "Предыдущая"
            html += `<li class="page-item ${data.first ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${data.currentPage - 1}">Предыдущая</a>
            </li>`;
            
            // Номера страниц (показываем максимум 7 страниц)
            const totalPages = data.totalPages;
            const current = data.currentPage;
            let startPage = Math.max(0, current - 3);
            let endPage = Math.min(totalPages - 1, current + 3);
            
            if (startPage > 0) {
                html += `<li class="page-item"><a class="page-link" href="#" data-page="0">1</a></li>`;
                if (startPage > 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === current ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                </li>`;
            }
            
            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages - 1}">${totalPages}</a></li>`;
            }
            
            // Кнопка "Следующая"
            html += `<li class="page-item ${data.last ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${data.currentPage + 1}">Следующая</a>
            </li>`;
            
            paginationList.innerHTML = html;
            
            // Обработчики событий уже настроены через делегирование на paginationContainer
            // Все ссылки пагинации имеют href="#", чтобы предотвратить стандартную навигацию
        }
        
        // Функция обновления иконок сортировки
        function updateSortIcons() {
            // Очищаем все иконки
            document.querySelectorAll('.offers-table .sortable .sort-icon').forEach(icon => {
                icon.innerHTML = '';
            });
            
            // Добавляем иконку к активной колонке
            const activeHeader = document.querySelector(`.offers-table .sortable[data-sort="${currentSortBy}"]`);
            if (activeHeader) {
                const icon = activeHeader.querySelector('.sort-icon');
                if (icon) {
                    const arrowDirection = currentSortDir === 'ASC' ? 'up' : 'down';
                    icon.innerHTML = `<i class="ph ph-arrow-${arrowDirection}"></i>`;
                }
            }
        }
        
        // Функция обновления активных кнопок фильтров
        function updateFilterButtons() {
            // Обновляем фильтры по дате
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                const filter = btn.getAttribute('data-filter');
                if (filter === currentDateFilter || (filter === '' && !currentDateFilter)) {
                    btn.classList.remove('btn-outline-main-two');
                    btn.classList.add('btn-main-two');
                } else {
                    btn.classList.remove('btn-main-two');
                    btn.classList.add('btn-outline-main-two');
                }
            });
            
            // Обновляем фильтры по типу операции (используем цвета сайта)
            document.querySelectorAll('.operation-filter-btn').forEach(btn => {
                const operation = btn.getAttribute('data-operation');
                if (operation === currentOperationType) {
                    // Активный фильтр - применяем заливку в цвете сайта
                    btn.classList.remove('btn-outline-main-two');
                    btn.classList.add('btn-main-two');
                } else {
                    // Неактивный фильтр - убираем заливку
                    btn.classList.remove('btn-main-two');
                    btn.classList.add('btn-outline-main-two');
                }
            });
            
            // Обновляем фильтр "Без пустых цен" (используем цвета сайта)
            document.querySelectorAll('.has-price-filter-btn').forEach(btn => {
                if (currentHasPrice === true) {
                    btn.classList.remove('btn-outline-main-two');
                    btn.classList.add('btn-main-two');
                } else {
                    btn.classList.remove('btn-main-two');
                    btn.classList.add('btn-outline-main-two');
                }
            });
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Обработчики для кнопок фильтров по дате
            // Используем делегирование событий для кнопок фильтров
            const filtersContainer = document.querySelector('.date-filters');
            if (filtersContainer) {
                filtersContainer.addEventListener('click', function(e) {
                    const btn = e.target.closest('.date-filter-btn');
                    if (!btn) {
                        return;
                    }
                    
                    // Предотвращаем стандартное поведение
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    const filter = btn.getAttribute('data-filter');
                    currentDateFilter = filter || ''; // Убеждаемся, что это строка
                    
                    console.log('Применение фильтра по дате:', {
                        filter: filter,
                        currentDateFilter: currentDateFilter,
                        currentSortBy: currentSortBy,
                        currentSortDir: currentSortDir
                    });
                    
                    // НЕ сбрасываем сортировку при применении фильтра
                    // Параметры сортировки сохраняются
                    currentPage = 0; // Сбрасываем только страницу на первую
                    loadOffers();
                    
                    // Предотвращаем всплытие события
                    return false;
                });
            } else {
                // Fallback для старых обработчиков, если контейнер не найден
                document.querySelectorAll('.date-filter-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        const filter = this.getAttribute('data-filter');
                        currentDateFilter = filter || '';
                        currentPage = 0;
                        loadOffers();
                        return false;
                    });
                });
            }
            
            // Обработчик для селекта размера страницы
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function() {
                    currentPageSize = parseInt(this.value);
                    currentPage = 0; // Сбрасываем на первую страницу
                    loadOffers();
                });
            }
            
            // Обработчики для фильтров по типу операции (Продажа/Покупка)
            // Используем делегирование событий
            const additionalFiltersContainer = document.querySelector('.additional-filters');
            if (additionalFiltersContainer) {
                additionalFiltersContainer.addEventListener('click', function(e) {
                    // Фильтр по типу операции
                    const operationBtn = e.target.closest('.operation-filter-btn');
                    if (operationBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        const operation = operationBtn.getAttribute('data-operation');
                        // Если кликнули по уже активному фильтру - снимаем фильтр
                        if (currentOperationType === operation) {
                            currentOperationType = null;
                        } else {
                            currentOperationType = operation;
                        }
                        
                        console.log('Применение фильтра по типу операции:', {
                            operation: operation,
                            currentOperationType: currentOperationType
                        });
                        
                        currentPage = 0; // Сбрасываем на первую страницу
                        loadOffers();
                        return false;
                    }
                    
                    // Фильтр "Без пустых цен"
                    const hasPriceBtn = e.target.closest('.has-price-filter-btn');
                    if (hasPriceBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        // Переключаем фильтр: если уже активен - снимаем, иначе включаем
                        if (currentHasPrice === true) {
                            currentHasPrice = null;
                        } else {
                            currentHasPrice = true;
                        }
                        
                        console.log('Применение фильтра "Без пустых цен":', {
                            hasPrice: currentHasPrice
                        });
                        
                        currentPage = 0; // Сбрасываем на первую страницу
                        loadOffers();
                        return false;
                    }
                });
            }
            
            // Обработчики для заголовков сортировки (используем делегирование событий)
            // Обрабатываем клики на уровне таблицы, чтобы работало даже после AJAX-обновления
            const offersTable = document.getElementById('offersTable');
            if (offersTable) {
                offersTable.addEventListener('click', function(e) {
                    // Проверяем, что клик был по заголовку с классом sortable
                    const header = e.target.closest('.sortable');
                    if (!header) {
                        return; // Клик был не по заголовку сортировки
                    }
                    
                    // Предотвращаем стандартное поведение ссылки
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    const sortBy = header.getAttribute('data-sort');
                    if (!sortBy) {
                        console.warn('Не найден атрибут data-sort у заголовка таблицы');
                        return;
                    }
                    
                    console.log('Клик по заголовку сортировки:', {
                        sortBy: sortBy,
                        currentSortBy: currentSortBy,
                        currentSortDir: currentSortDir,
                        currentDateFilter: currentDateFilter
                    });
                    
                    // Определяем новое направление сортировки
                    if (sortBy === currentSortBy) {
                        currentSortDir = currentSortDir === 'ASC' ? 'DESC' : 'ASC';
                    } else {
                        currentSortBy = sortBy;
                        currentSortDir = 'DESC';
                    }
                    
                    console.log('Новые параметры сортировки:', {
                        currentSortBy: currentSortBy,
                        currentSortDir: currentSortDir,
                        currentDateFilter: currentDateFilter
                    });
                    
                    currentPage = 0; // Сбрасываем на первую страницу
                    loadOffers();
                    
                    // Предотвращаем всплытие события
                    return false;
                });
            }
            
            // Инициализация пагинации при первой загрузке (используем делегирование событий)
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationList = document.getElementById('paginationList');
            
            if (paginationContainer) {
                // Используем делегирование событий для обработки кликов по пагинации
                // Это работает даже после AJAX-обновления таблицы
                paginationContainer.addEventListener('click', function(e) {
                    const link = e.target.closest('a.page-link[data-page]');
                    if (!link) {
                        return;
                    }
                    
                    // Предотвращаем стандартное поведение ссылки
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    const pageItem = link.closest('.page-item');
                    if (pageItem && !pageItem.classList.contains('disabled')) {
                        const page = parseInt(link.getAttribute('data-page'));
                        if (!isNaN(page) && page >= 0) {
                            currentPage = page;
                            loadOffers();
                        }
                    }
                    
                    // Предотвращаем всплытие события
                    return false;
                });
                
                // Показываем пагинацию, если она есть
                if (paginationList && paginationList.querySelectorAll('.page-link[data-page]').length > 0) {
                    paginationContainer.style.display = 'block';
                }
            }
            
            // Обновляем иконки сортировки при первой загрузке (на основе серверных данных)
            updateSortIcons();
            
            // Обновляем состояние кнопок фильтров при первой загрузке
            updateFilterButtons();
        });
        
        // Функция открытия модального окна заявки
        function openRequestModal(offerId) {
            const modalElement = document.getElementById('requestModal');
            if (!modalElement) {
                console.error('Модальное окно requestModal не найдено');
                return;
            }
            const modal = new bootstrap.Modal(modalElement);
            document.getElementById('requestOfferId').value = offerId;
            document.getElementById('requestForm').reset();
            modal.show();
        }
        
        // Обработчик отправки формы заявки
        document.addEventListener('DOMContentLoaded', function() {
            const requestForm = document.getElementById('requestForm');
            if (requestForm) {
                requestForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const offerId = document.getElementById('requestOfferId').value;
                    const clientName = document.getElementById('clientName').value.trim();
                    const clientPhone = document.getElementById('clientPhone').value.trim();
                    const message = document.getElementById('requestMessage').value.trim();
                    
                    // Валидация
                    if (!clientName) {
                        alert('Пожалуйста, укажите ваше имя');
                        return;
                    }
                    
                    if (!clientPhone) {
                        alert('Пожалуйста, укажите ваш телефон');
                        return;
                    }
                    
                    // Отправка заявки
                    const submitBtn = document.getElementById('submitRequestBtn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Отправка...';
                    
                    fetch('/requests/api/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            offerId: parseInt(offerId),
                            clientName: clientName,
                            clientPhone: clientPhone,
                            message: message || null
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        
                        if (data.error) {
                            alert('Ошибка: ' + data.error);
                        } else {
                            alert('Заявка успешно отправлена! Мы свяжемся с вами в ближайшее время.');
                            const modalElement = document.getElementById('requestModal');
                            const modal = bootstrap.Modal.getInstance(modalElement);
                            if (modal) {
                                modal.hide();
                            }
                            document.getElementById('requestForm').reset();
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при отправке заявки:', error);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        alert('Произошла ошибка при отправке заявки. Попробуйте еще раз.');
                    });
                });
            }
        });
        /*]]>*/
    </script>

    <!-- Модальное окно для отправки заявки -->
    <div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="requestModalLabel">
                        <i class="ph ph-paper-plane-tilt"></i> Отправить заявку
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="requestForm">
                    <div class="modal-body">
                        <input type="hidden" id="requestOfferId" name="offerId">
                        
                        <div class="mb-24">
                            <label for="clientName" class="form-label fw-semibold">
                                Ваше имя <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="clientName" 
                                   name="clientName" 
                                   required 
                                   placeholder="Введите ваше имя">
                        </div>
                        
                        <div class="mb-24">
                            <label for="clientPhone" class="form-label fw-semibold">
                                Телефон <span class="text-danger">*</span>
                            </label>
                            <input type="tel" 
                                   class="form-control" 
                                   id="clientPhone" 
                                   name="clientPhone" 
                                   required 
                                   placeholder="+7 (XXX) XXX-XX-XX">
                        </div>
                        
                        <div class="mb-24">
                            <label for="requestMessage" class="form-label fw-semibold">
                                Сообщение (необязательно)
                            </label>
                            <textarea class="form-control" 
                                      id="requestMessage" 
                                      name="message" 
                                      rows="4" 
                                      placeholder="Укажите дополнительные детали, если необходимо"></textarea>
                        </div>
                        
                        <div class="alert alert-info mb-0">
                            <i class="ph ph-info"></i> 
                            <small>Мы свяжемся с вами в ближайшее время для уточнения деталей.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-main-two" id="submitRequestBtn">
                            <i class="ph ph-paper-plane-tilt"></i> Отправить заявку
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    </body>
</html>

