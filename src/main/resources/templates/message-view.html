<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è - MinerHive</title>
    
    <!-- Yandex Verification -->
    <meta name="yandex-verification" content="501f7cbb3e1af62f" />
    
    <!-- Favicon -->
    <th:block th:replace="~{fragments/favicon :: favicon-tags}"></th:block>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .json-container {
            background-color: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 600px;
            overflow-y: auto;
        }
        .json-key {
            color: #e06c75;
        }
        .json-string {
            color: #98c379;
        }
        .json-number {
            color: #d19a66;
        }
        .json-boolean {
            color: #56b6c2;
        }
        .json-null {
            color: #c678dd;
        }
        .section-card {
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .section-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        .section-body {
            padding: 20px;
        }
        .info-row {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
            min-width: 150px;
            display: inline-block;
        }
        .copy-btn {
            margin-top: 10px;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">MinerHive</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a class="nav-link" href="/products">–¢–æ–≤–∞—Ä—ã</a>
                <a class="nav-link active" href="/private/messages">–°–æ–æ–±—â–µ–Ω–∏—è</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="mb-3">
            <a href="/private/messages" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
            <a th:href="@{'/private/messages/' + ${message.id} + '/json'}" target="_blank" class="btn btn-outline-primary ms-2">
                üìÑ JSON API
            </a>
        </div>

        <div th:if="${error}" class="alert alert-danger">
            <span th:text="${error}">–û—à–∏–±–∫–∞</span>
        </div>

        <div th:if="${message != null}">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ -->
            <div class="section-card">
                <div class="section-header">
                    üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏–∏
                </div>
                <div class="section-body">
                    <div class="info-row">
                        <span class="info-label">ID:</span>
                        <span th:text="${message.id}">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Message ID:</span>
                        <span th:text="${message.messageId}">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–ß–∞—Ç:</span>
                        <span th:text="${message.chatName}">-</span>
                        <span class="badge bg-secondary ms-2" th:text="${message.chatType}">type</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                        <span th:text="${message.senderName}">-</span>
                        <span class="text-muted ms-2" th:text="${message.senderPhoneNumber}">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–í—Ä–µ–º—è:</span>
                        <span th:text="${message.timestamp}">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                        <span th:if="${message.isUpdate}" class="badge bg-warning me-1">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
                        <span th:if="${message.parsedData != null && !#strings.isEmpty(message.parsedData)}" 
                              class="badge bg-success me-1">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é</span>
                        <span th:if="${message.parsedData == null || #strings.isEmpty(message.parsedData)}" 
                              class="badge bg-danger me-1">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
                    </div>
                </div>
            </div>

            <!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ WhatsApp -->
            <div class="section-card">
                <div class="section-header">
                    üí¨ –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ WhatsApp
                </div>
                <div class="section-body">
                    <div class="mb-3">
                        <strong>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</strong>
                        <div class="mt-2 p-3 bg-light border rounded" style="white-space: pre-wrap;" 
                             th:text="${message.content}">Content</div>
                    </div>
                    <div>
                        <strong>JSON —Ñ–æ—Ä–º–∞—Ç:</strong>
                        <button class="btn btn-sm btn-outline-secondary copy-btn" 
                                onclick="copyToClipboard('original-json')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <div id="original-json" class="json-container mt-2" th:utext="${originalMessageJson}">JSON</div>
                    </div>
                </div>
            </div>

            <!-- –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ -->
            <div class="section-card" th:if="${parsedData != null}">
                <div class="section-header">
                    ü§ñ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (Ollama)
                </div>
                <div class="section-body">
                    <div class="alert alert-success mb-3">
                        ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
                    </div>
                    <div>
                        <strong>JSON —Ñ–æ—Ä–º–∞—Ç:</strong>
                        <button class="btn btn-sm btn-outline-secondary copy-btn" 
                                onclick="copyToClipboard('parsed-json')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <div id="parsed-json" class="json-container mt-2" th:utext="${parsedDataJson}">Parsed JSON</div>
                    </div>
                </div>
            </div>

            <div class="section-card" th:if="${parsedData == null}">
                <div class="section-header">
                    ü§ñ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (Ollama)
                </div>
                <div class="section-body">
                    <div class="alert alert-warning mb-0">
                        ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é. –í–æ–∑–º–æ–∂–Ω–æ, Ollama –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è JSON –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            
            navigator.clipboard.writeText(text).then(function() {
                // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(function() {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(function(err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ JSON (–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è)
        document.addEventListener('DOMContentLoaded', function() {
            const jsonContainers = document.querySelectorAll('.json-container');
            jsonContainers.forEach(container => {
                let text = container.textContent;
                // –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ JSON (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
                text = text.replace(/("([^"\\]|\\.)*")\s*:/g, '<span class="json-key">$1</span>:');
                text = text.replace(/:\s*("([^"\\]|\\.)*")/g, ': <span class="json-string">$1</span>');
                text = text.replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-number">$1</span>');
                text = text.replace(/:\s*(true|false)/g, ': <span class="json-boolean">$1</span>');
                text = text.replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
                container.innerHTML = text;
            });
        });
    </script>
</body>
</html>

