<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ru" dir="ltr" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light" data-menu-styles="light" data-toggled="close">

<head>
    <!-- Meta Data -->
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Таблица продуктов - MinerHive</title>
    <meta name="Description" content="Таблица всех продуктов интернет-магазина MinerHive">
    
    <!-- Yandex Verification -->
    <meta name="yandex-verification" content="501f7cbb3e1af62f" />
    
    <!-- Favicon -->
    <th:block th:replace="~{fragments/favicon :: favicon-tags}"></th:block>
    
    <!-- Choices JS -->
    <script th:src="@{/bootstrap-theme/assets/libs/choices.js/public/assets/scripts/choices.min.js}" src="../assets/libs/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <!-- Bootstrap Css -->
    <link id="style" th:href="@{/bootstrap-theme/assets/libs/bootstrap/css/bootstrap.min.css}" href="../assets/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Style Css -->
    <link th:href="@{/bootstrap-theme/assets/css/styles.min.css}" href="../assets/css/styles.min.css" rel="stylesheet">

    <!-- Icons Css -->
    <link th:href="@{/bootstrap-theme/assets/css/icons.css}" href="../assets/css/icons.css" rel="stylesheet">

    <!-- Node Waves Css -->
    <link th:href="@{/bootstrap-theme/assets/libs/node-waves/waves.min.css}" href="../assets/libs/node-waves/waves.min.css" rel="stylesheet"> 
    
    <!-- Simplebar Css -->
    <link th:href="@{/bootstrap-theme/assets/libs/simplebar/simplebar.min.css}" href="../assets/libs/simplebar/simplebar.min.css" rel="stylesheet">
    
    <!-- Color Picker Css -->
    <link rel="stylesheet" th:href="@{/bootstrap-theme/assets/libs/flatpickr/flatpickr.min.css}" href="../assets/libs/flatpickr/flatpickr.min.css">
    <link rel="stylesheet" th:href="@{/bootstrap-theme/assets/libs/@simonwep/pickr/themes/nano.min.css}" href="../assets/libs/@simonwep/pickr/themes/nano.min.css">

    <!-- Choices Css -->
    <link rel="stylesheet" th:href="@{/bootstrap-theme/assets/libs/choices.js/public/assets/styles/choices.min.css}" href="../assets/libs/choices.js/public/assets/styles/choices.min.css">
    
    <!-- Custom styles для таблицы продуктов -->
    <style>
        /* Восстановление прокрутки страницы - полная версия */
        html {
            overflow-x: hidden !important;
            overflow-y: scroll !important; /* Всегда показываем полосу прокрутки */
            height: 100% !important;
        }
        
        body {
            overflow-x: hidden !important;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 100vh !important;
            position: relative !important;
        }
        
        /* Основной контейнер страницы должен прокручиваться */
        .page {
            overflow-x: hidden !important;
            overflow-y: visible !important;
            height: auto !important;
            min-height: 100vh !important;
        }
        
        /* Контент должен прокручиваться */
        .main-content, .app-content {
            overflow-x: hidden !important;
            overflow-y: visible !important;
            height: auto !important;
            min-height: 100vh !important;
        }
        
        /* Гарантируем, что body может прокручиваться даже с модальными окнами */
        body.modal-open {
            overflow-y: scroll !important;
            padding-right: 0 !important;
        }
        
        /* Принудительно показываем стандартную полосу прокрутки */
        ::-webkit-scrollbar {
            width: 10px !important;
            height: 10px !important;
            display: block !important;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1 !important;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888 !important;
            border-radius: 5px !important;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555 !important;
        }
        
        /* Для Firefox */
        html {
            scrollbar-width: thin !important;
            scrollbar-color: #888 #f1f1f1 !important;
        }
        
        .products-table {
            font-size: 0.875rem;
        }
        
        .products-table thead th {
            background-color: #2c3e50;
            color: #ffffff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 10px 12px;
            white-space: nowrap;
        }
        
        .products-table thead th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .products-table thead th.sortable:hover {
            background-color: #34495e;
        }
        
        .products-table tbody td {
            padding: 8px 12px;
            vertical-align: middle;
        }
        
        .sort-icon {
            margin-left: 8px;
            font-size: 0.75rem;
        }
        
        /* Стили для модального окна с таблицей MinerDetails */
        #minerDetailsTableContainer {
            max-height: 400px;
            overflow-y: auto;
        }
        
        #minerDetailsTableContainer thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
        }
        
        .miner-detail-row:hover {
            background-color: #f8f9fa;
        }
        
        .miner-detail-row.table-primary {
            background-color: #cfe2ff;
        }
        
        #minerDetailsTableContainer::-webkit-scrollbar {
            width: 8px;
        }
        
        #minerDetailsTableContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #minerDetailsTableContainer::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        #minerDetailsTableContainer::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
    
    <!-- Fix for missing DOM elements - MUST be before other scripts -->
    <script>
        // Агрессивный обработчик ошибок для подавления ошибок из скриптов темы
        // Устанавливается самым первым, до всех остальных скриптов
        (function() {
            'use strict';
            
            // Функция для проверки, нужно ли подавить ошибку
            function shouldSuppressError(message, filename, stack) {
                const messageStr = String(message || '');
                const filenameStr = String(filename || '');
                const stackStr = String(stack || '');
                
                // Проверяем по всем параметрам
                const checks = [
                    messageStr.includes('Cannot read properties of null'),
                    messageStr.includes('addEventListener'),
                    messageStr.includes('appendChild'),
                    messageStr.includes('classList'),
                    filenameStr.includes('custom-switcher'),
                    filenameStr.includes('custom.js'),
                    stackStr.includes('custom-switcher'),
                    stackStr.includes('custom.js'),
                    stackStr.includes('switcherClick'),
                    filenameStr.includes('custom-switcher.min.js')
                ];
                
                return checks.some(function(check) { return check; });
            }
            
            // Перехватываем console.error
            if (typeof console !== 'undefined' && console.error) {
                const originalError = console.error.bind(console);
                console.error = function(...args) {
                    const errorText = args.map(function(arg) {
                        return typeof arg === 'object' ? JSON.stringify(arg) : String(arg);
                    }).join(' ');
                    
                    if (shouldSuppressError(errorText, '', '')) {
                        return; // Подавляем вывод
                    }
                    originalError.apply(console, args);
                };
            }
            
            // Перехватываем window.onerror (старый способ)
            const originalOnError = window.onerror;
            window.onerror = function(message, filename, lineno, colno, error) {
                const stack = error && error.stack ? error.stack : '';
                if (shouldSuppressError(message, filename, stack)) {
                    return true; // Подавляем ошибку
                }
                if (originalOnError) {
                    return originalOnError.apply(window, arguments);
                }
                return false;
            };
            
            // Перехватываем через addEventListener (новый способ)
            window.addEventListener('error', function(e) {
                const error = e.error || {};
                const stack = error.stack || '';
                
                if (shouldSuppressError(e.message, e.filename, stack)) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return true;
                }
            }, true); // Используем capture phase для раннего перехвата
            
            // Перехватываем unhandledrejection
            window.addEventListener('unhandledrejection', function(e) {
                const reason = e.reason || {};
                let reasonStr = '';
                
                if (typeof reason === 'string') {
                    reasonStr = reason;
                } else if (reason.message) {
                    reasonStr = reason.message;
                } else if (reason.stack) {
                    reasonStr = reason.stack;
                }
                
                if (shouldSuppressError(reasonStr, '', reason.stack || '')) {
                    e.preventDefault();
                    return true;
                }
            }, true);
        })();
        
        // Ensure all required DOM elements exist before scripts execute
        (function() {
            function ensureElements() {
                // Ensure horizontal menu exists in the correct location
                let horizontalMenu = document.querySelector('.horizontal-menu');
                if (!horizontalMenu) {
                    let headerCenter = document.querySelector('.main-header-center');
                    if (!headerCenter) {
                        // Find header-element or create it
                        const headerContentLeft = document.querySelector('.header-content-left');
                        if (headerContentLeft) {
                            headerCenter = document.createElement('div');
                            headerCenter.className = 'main-header-center d-none d-lg-block';
                            headerCenter.style.display = 'none';
                            const headerElement = headerContentLeft.querySelector('.header-element');
                            if (headerElement) {
                                headerElement.appendChild(headerCenter);
                            } else {
                                headerContentLeft.appendChild(headerCenter);
                            }
                        }
                    }
                    if (headerCenter) {
                        horizontalMenu = document.createElement('nav');
                        horizontalMenu.className = 'horizontal-menu';
                        horizontalMenu.style.display = 'none';
                        headerCenter.appendChild(horizontalMenu);
                    }
                }
                
                // Ensure loader element exists
                let loader = document.getElementById('loader');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'loader';
                    loader.style.display = 'none';
                    if (document.body) {
                        document.body.insertBefore(loader, document.body.firstChild);
                    }
                }
                
                // Ensure switcher-canvas exists
                let switcherCanvas = document.getElementById('switcher-canvas');
                if (!switcherCanvas) {
                    switcherCanvas = document.createElement('div');
                    switcherCanvas.className = 'offcanvas offcanvas-end';
                    switcherCanvas.id = 'switcher-canvas';
                    switcherCanvas.setAttribute('tabindex', '-1');
                    switcherCanvas.setAttribute('aria-labelledby', 'offcanvasRightLabel');
                    switcherCanvas.style.display = 'none';
                    if (document.body) {
                        document.body.appendChild(switcherCanvas);
                    }
                }
                
                // Ensure header-sidebar exists
                let headerSidebar = document.getElementById('header-sidebar');
                if (!headerSidebar) {
                    headerSidebar = document.createElement('div');
                    headerSidebar.className = 'offcanvas offcanvas-end';
                    headerSidebar.id = 'header-sidebar';
                    headerSidebar.setAttribute('tabindex', '-1');
                    headerSidebar.setAttribute('aria-labelledby', 'sidebarLabel');
                    headerSidebar.style.display = 'none';
                    if (document.body) {
                        document.body.appendChild(headerSidebar);
                    }
                }
            }
            
            // Run when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', ensureElements);
            } else {
                // DOM already loaded
                ensureElements();
            }
            
            // Also run immediately to catch early script execution
            if (document.body) {
                ensureElements();
            }
        })();
    </script>
</head> 

<body>
    <!-- Page Loader -->
    <div id="loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <!-- Page Loader -->

    <!-- Start Switcher -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="switcher-canvas" aria-labelledby="offcanvasRightLabel">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title text-default" id="offcanvasRightLabel">Switcher</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <nav class="border-bottom border-block-end-dashed">
                <div class="nav nav-tabs nav-justified" id="switcher-main-tab" role="tablist">
                    <button class="nav-link active" id="switcher-home-tab" data-bs-toggle="tab" data-bs-target="#switcher-home"
                        type="button" role="tab" aria-controls="switcher-home" aria-selected="true">Theme Styles</button>
                    <button class="nav-link" id="switcher-profile-tab" data-bs-toggle="tab" data-bs-target="#switcher-profile"
                        type="button" role="tab" aria-controls="switcher-profile" aria-selected="false">Theme Colors</button>
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active border-0" id="switcher-home" role="tabpanel" aria-labelledby="switcher-home-tab" tabindex="0">
                    <div class="">
                        <p class="switcher-style-head">Theme Color Mode:</p>
                        <div class="row switcher-style gx-0">
                            <div class="col-4">
                                <div class="form-check switch-select">
                                    <label class="form-check-label" for="switcher-light-theme">Light</label>
                                    <input class="form-check-input" type="radio" name="theme-style" id="switcher-light-theme" checked>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-check switch-select">
                                    <label class="form-check-label" for="switcher-dark-theme">Dark</label>
                                    <input class="form-check-input" type="radio" name="theme-style" id="switcher-dark-theme">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade border-0" id="switcher-profile" role="tabpanel" aria-labelledby="switcher-profile-tab" tabindex="0">
                        <div class="">
                            <p class="switcher-style-head">Menu Colors:</p>
                            <div class="d-flex switcher-style pb-2">
                                <div class="form-check switch-select me-2">
                                    <input class="form-check-input" type="radio" name="menu-colors" id="switcher-menu-light" checked>
                                    <label class="form-check-label" for="switcher-menu-light">Light</label>
                                </div>
                                <div class="form-check switch-select me-2">
                                    <input class="form-check-input" type="radio" name="menu-colors" id="switcher-menu-dark">
                                    <label class="form-check-label" for="switcher-menu-dark">Dark</label>
                                </div>
                                <div class="form-check switch-select">
                                    <input class="form-check-input" type="radio" name="menu-colors" id="switcher-menu-primary">
                                    <label class="form-check-label" for="switcher-menu-primary">Primary</label>
                                </div>
                            </div>
                        </div>
                        <div class="">
                            <p class="switcher-style-head">Header Colors:</p>
                            <div class="d-flex switcher-style pb-2">
                                <div class="form-check switch-select me-2">
                                    <input class="form-check-input" type="radio" name="header-colors" id="switcher-header-light" checked>
                                    <label class="form-check-label" for="switcher-header-light">Light</label>
                                </div>
                                <div class="form-check switch-select me-2">
                                    <input class="form-check-input" type="radio" name="header-colors" id="switcher-header-dark">
                                    <label class="form-check-label" for="switcher-header-dark">Dark</label>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Switcher -->

    <!-- Start::Off-canvas sidebar-->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="header-sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header rounded-0">
            <h5 class="fs-14 text-uppercase mb-0 fw-semibold" id="sidebarLabel">Меню</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body rounded-0 p-0">
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><a th:href="@{/private}" class="text-dark">Панель управления</a></li>
                <li class="list-group-item" sec:authorize="hasRole('ADMIN')"><a th:href="@{/private/messages}" class="text-dark">Сообщения</a></li>
                <li class="list-group-item" sec:authorize="hasRole('ADMIN')"><a th:href="@{/private/products/table}" class="text-dark">Таблица товаров</a></li>
                <li class="list-group-item"><a th:href="@{/private/requests}" class="text-dark">Заявки</a></li>
                <li class="list-group-item"><a th:href="@{/private/miner-details}" class="text-dark">Детали майнеров</a></li>
                <li class="list-group-item"><a th:href="@{/private/profitability}" class="text-dark">Калькулятор доходности</a></li>
                <li class="list-group-item" sec:authorize="hasRole('ADMIN')"><a th:href="@{/private/users}" class="text-dark">Пользователи</a></li>
            </ul>
        </div>
    </div>
    <!-- End::Off-canvas sidebar-->

    <div class="page">
        <!-- app-header -->
        <header class="app-header">
            <!-- Start::main-header-container -->
            <div class="main-header-container container-fluid">
                <!-- Start::header-content-left -->
                <div class="header-content-left">
                    <!-- Start::header-element -->
                    <div class="header-element">
                        <div class="horizontal-logo">
                            <a th:href="@{/}" class="header-logo">
                                <img th:src="@{/bootstrap-theme/assets/images/brand-logos/desktop-logo.png}" src="../assets/images/brand-logos/desktop-logo.png" alt="logo" class="desktop-logo">
                                <img th:src="@{/bootstrap-theme/assets/images/brand-logos/toggle-logo.png}" src="../assets/images/brand-logos/toggle-logo.png" alt="logo" class="toggle-logo">
                                <img th:src="@{/bootstrap-theme/assets/images/brand-logos/desktop-white.png}" src="../assets/images/brand-logos/desktop-white.png" alt="logo" class="desktop-white">
                                <img th:src="@{/bootstrap-theme/assets/images/brand-logos/toggle-white.png}" src="../assets/images/brand-logos/toggle-white.png" alt="logo" class="toggle-white">
                            </a>
                        </div>
                    </div>
                    <!-- End::header-element -->

                    <!-- Start::header-element -->
                    <div class="header-element">
                        <!-- Start::header-link -->
                        <a aria-label="Hide Sidebar" class="sidemenu-toggle header-link animated-arrow hor-toggle horizontal-navtoggle" data-bs-toggle="sidebar" href="javascript:void(0);">
                            <i class="header-icon fe fe-align-left"></i>
                        </a>
                        <!-- End::header-link -->
                        <!-- Horizontal Menu Container (hidden, but needed for scripts) -->
                        <div class="main-header-center d-none d-lg-block" style="display: none !important;">
                            <nav class="horizontal-menu"></nav>
                        </div>
                    </div>
                    <!-- End::header-element -->
                </div>
                <!-- End::header-content-left -->

                <!-- Start::header-content-right -->
                <div class="header-content-right">
                    <!-- Start::header-element -->
                    <div class="header-element header-sidebar">
                        <!-- Start::header-link-->
                        <a href="javascript:void(0);" class="header-link" data-bs-toggle="offcanvas" data-bs-target="#header-sidebar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="header-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" ><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </a>
                        <!-- End::header-link-->
                    </div>
                    <!-- End::header-element -->

                    <!-- Start::header-element -->
                    <div class="header-element">
                        <!-- Start::header-link|switcher-icon -->
                        <a href="javascript:void(0);" class="header-link switcher-icon" data-bs-toggle="offcanvas" data-bs-target="#switcher-canvas">
                            <svg xmlns="http://www.w3.org/2000/svg" class="header-link-icon" width="24" height="24" viewBox="0 0 24 24"><path d="M12 16c2.206 0 4-1.794 4-4s-1.794-4-4-4-4 1.794-4 4 1.794 4 4 4zm0-6c1.084 0 2 .916 2 2s-.916 2-2 2-2-.916-2-2 .916-2 2-2z"></path><path d="m2.845 16.136 1 1.73c.531.917 1.809 1.261 2.73.73l.529-.306A8.1 8.1 0 0 0 9 19.402V20c0 1.103.897 2 2 2h2c1.103 0 2-.897 2-2v-.598a8.132 8.132 0 0 0 1.896-1.111l.529.306c.923.53 2.198.188 2.731-.731l.999-1.729a2.001 2.001 0 0 0-.731-2.732l-.505-.292a7.718 7.718 0 0 0 0-2.224l.505-.292a2.002 2.002 0 0 0 .731-2.732l-.999-1.729c-.531-.92-1.808-1.265-2.731-.732l-.529.306A8.1 8.1 0 0 0 15 4.598V4c0-1.103-.897-2-2-2h-2c-1.103 0-2 .897-2 2v.598a8.132 8.132 0 0 0-1.896 1.111l-.529-.306c-.924-.531-2.2-.187-2.731.732l-.999 1.729a2.001 2.001 0 0 0 .731 2.732l.505.292a7.683 7.683 0 0 0 0 2.223l-.505.292a2.003 2.003 0 0 0-.731 2.733zm3.326-2.758A5.703 5.703 0 0 1 6 12c0-.462.058-.926.17-1.378a.999.999 0 0 0-.47-1.108l-1.123-.65.998-1.729 1.145.662a.997.997 0 0 0 1.188-.142 6.071 6.071 0 0 1 2.384-1.399A1 1 0 0 0 11 5.3V4h2v1.3a1 1 0 0 0 .708.956 6.083 6.083 0 0 1 2.384 1.399.999.999 0 0 0 1.188.142l1.144-.661 1 1.729-1.124.649a1 1 0 0 0-.47 1.108c.112.452.17.916.17 1.378 0 .461-.058.925-.171 1.378a1 1 0 0 0 .471 1.108l1.123.649-.998 1.729-1.145-.661a.996.996 0 0 0-1.188.142 6.071 6.071 0 0 1-2.384 1.399A1 1 0 0 0 13 18.7l.002 1.3H11v-1.3a1 1 0 0 0-.708-.956 6.083 6.083 0 0 1-2.384-1.399.992.992 0 0 0-1.188-.141l-1.144.662-1-1.729 1.124-.651a1 1 0 0 0 .471-1.108z"></path></svg>
                        </a>
                        <!-- End::header-link|switcher-icon -->
                    </div>
                    <!-- End::header-element -->

                    <!-- Start::header-element -->
                    <div class="header-element headerProfile-dropdown">
                        <!-- Start::header-link|dropdown-toggle -->
                        <a href="javascript:void(0);" class="header-link dropdown-toggle" id="mainHeaderProfile" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            <i class="fe fe-user fs-20"></i>
                        </a>
                        <!-- End::header-link|dropdown-toggle -->
                        <ul class="main-header-dropdown dropdown-menu pt-0 header-profile-dropdown dropdown-menu-end main-profile-menu" aria-labelledby="mainHeaderProfile">
                            <li>
                                <div class="main-header-profile bg-primary menu-header-content text-fixed-white">
                                    <div class="my-auto">
                                        <h6 class="mb-0 lh-1 text-fixed-white">
                                            <span sec:authorize="hasRole('ADMIN')">Администратор</span>
                                            <span sec:authorize="hasRole('MANAGER') and !hasRole('ADMIN')">Менеджер</span>
                                        </h6>
                                        <span class="fs-11 op-7 lh-1">MinerHive</span>
                                    </div>
                                </div>
                            </li>
                            <li><a class="dropdown-item d-flex" th:href="@{/}"><i class="bx bx-home fs-18 me-2 op-7"></i>Главная</a></li>
                            <li><a class="dropdown-item d-flex border-block-end" th:href="@{/logout}"><i class="bx bx-log-out fs-18 me-2 op-7"></i>Выход</a></li>
                        </ul>
                    </div>  
                    <!-- End::header-element -->
                </div>
                <!-- End::header-content-right -->
            </div>
            <!-- End::main-header-container -->
        </header>
        <!-- /app-header -->

        <!-- Start::app-sidebar -->
        <aside class="app-sidebar sticky" id="sidebar">
            <!-- Start::main-sidebar-header -->
            <div class="main-sidebar-header">
                <a th:href="@{/}" class="header-logo">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/desktop-logo.png}" src="../assets/images/brand-logos/desktop-logo.png" alt="logo" class="desktop-logo">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/toggle-logo.png}" src="../assets/images/brand-logos/toggle-logo.png" alt="logo" class="toggle-logo">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/desktop-white.png}" src="../assets/images/brand-logos/desktop-white.png" alt="logo" class="desktop-white">
                    <img th:src="@{/bootstrap-theme/assets/images/brand-logos/toggle-white.png}" src="../assets/images/brand-logos/toggle-white.png" alt="logo" class="toggle-white">
                </a>
            </div>
            <!-- End::main-sidebar-header -->

            <!-- Start::main-sidebar -->
            <div class="main-sidebar" id="sidebar-scroll">
                <!-- Start::nav -->
                <nav class="main-menu-container nav nav-pills flex-column sub-open">
                    <div class="slide-left" id="slide-left">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191" width="24" height="24" viewBox="0 0 24 24"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"></path> </svg>
                    </div>
                    <ul class="main-menu">
                        <!-- Start::slide__category -->
                        <li class="slide__category"><span class="category-name">Главное</span></li>
                        <!-- End::slide__category -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M5 5h4v6H5zm10 8h4v6h-4zM5 17h4v2H5zM15 5h4v2h-4z" opacity=".3"/><path d="M3 13h8V3H3v10zm2-8h4v6H5V5zm8 16h8V11h-8v10zm2-8h4v6h-4v-6zM13 3v6h8V3h-8zm6 4h-4V5h4v2zM3 21h8v-6H3v6zm2-4h4v2H5v-2z"/></svg>
                                <span class="side-menu__label">Панель управления</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide__category -->
                        <li class="slide__category"><span class="category-name">Управление</span></li>
                        <!-- End::slide__category -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/private/messages}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                                <span class="side-menu__label">Сообщения</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/private/products/table}" class="side-menu__item active">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 5H5v14h14V5zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" opacity=".3"/><path d="M3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2zm2 0h14v14H5V5zm2 5h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/></svg>
                                <span class="side-menu__label">Таблица товаров</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private/requests}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                                <span class="side-menu__label">Заявки</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private/miner-details}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                                <span class="side-menu__label">Детали майнеров</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide -->
                        <li class="slide">
                            <a th:href="@{/private/profitability}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                <span class="side-menu__label">Калькулятор доходности</span>
                            </a>
                        </li>
                        <!-- End::slide -->

                        <!-- Start::slide__category -->
                        <li class="slide__category" sec:authorize="hasRole('ADMIN')"><span class="category-name">Администрирование</span></li>
                        <!-- End::slide__category -->

                        <!-- Start::slide -->
                        <li class="slide" sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/private/users}" class="side-menu__item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="side-menu__icon" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-3.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-3.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                <span class="side-menu__label">Пользователи</span>
                            </a>
                        </li>
                        <!-- End::slide -->
                    </ul>
                    <div class="slide-right" id="slide-right"><svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191" width="24" height="24" viewBox="0 0 24 24"> <path d="M10.707 17.707 16.414 12l-5.707-5.707-1.414 1.414L13.586 12l-4.293 4.293z"></path> </svg></div>
                </nav>
                <!-- End::nav -->
            </div>
            <!-- End::main-sidebar -->
        </aside>
        <!-- End::app-sidebar -->

        <!-- Start::app-content -->
        <div class="main-content app-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb">
                    <div class="my-auto">
                        <h5 class="page-title fs-21 mb-1">Таблица продуктов</h5>
                        <nav>
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a th:href="@{/}">Главная</a></li>
                                <li class="breadcrumb-item"><a th:href="@{/private}">Панель управления</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Таблица продуктов</li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <!-- Page Header Close -->

                <!-- Start::row-1 -->
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header">
                                <div class="card-title">Все товары в базе данных</div>
                            </div>
                            <div class="card-body">
                                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <span th:text="${error}"></span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                                
                                <!-- Фильтры по производителям -->
                                <div class="mb-3" th:if="${manufacturers != null and !#lists.isEmpty(manufacturers)}">
                                    <div class="d-flex align-items-center flex-wrap gap-2">
                                        <span class="text-muted fw-semibold">Фильтр по производителю:</span>
                                        <a th:href="@{/private/products/table(page=0, sortBy=${sortBy}, sortDir=${sortDir})}" 
                                           class="btn btn-sm" 
                                           th:classappend="${currentManufacturer == '' || currentManufacturer == null} ? 'btn-primary' : 'btn-outline-primary'">
                                            Все
                                        </a>
                                        <a th:each="mfr : ${manufacturers}"
                                           th:href="@{/private/products/table(page=0, sortBy=${sortBy}, sortDir=${sortDir}, manufacturer=${mfr})}" 
                                           class="btn btn-sm"
                                           th:classappend="${currentManufacturer == mfr} ? 'btn-primary' : 'btn-outline-primary'"
                                           th:text="${mfr}">
                                            Производитель
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Информация о количестве записей -->
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <div class="text-muted">
                                        Показано 
                                        <span th:text="${productsPage.number * productsPage.size + #lists.size(productsPage.content)}">0</span> из 
                                        <span th:text="${productsPage.totalElements}">0</span>
                                    </div>
                                </div>
                                
                                <!-- Таблица продуктов -->
                                <div class="table-responsive">
                                    <table class="table products-table text-nowrap" id="productsTable">
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-sort="id">
                                                    ID
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="model">
                                                    Модель
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="manufacturer">
                                                    Производитель
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th>MinerDetail</th>
                                                <th>Предложения</th>
                                                <th class="sortable" data-sort="minPrice">
                                                    Мин. цена
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="createdAt">
                                                    Создан
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th class="sortable" data-sort="updatedAt">
                                                    Обновлен
                                                    <span class="sort-icon"></span>
                                                </th>
                                                <th>Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:if="${#lists.isEmpty(productsPage.content)}">
                                                <td colspan="9" class="text-center py-24 text-muted">
                                                    Продукты не найдены
                                                </td>
                                            </tr>
                                            <tr th:each="product : ${productsPage.content}">
                                                <td th:text="${product.id}">1</td>
                                                <td>
                                                    <a th:href="@{/products/{id}(id=${product.id})}" 
                                                       class="text-primary hover-text-decoration-underline"
                                                       th:text="${product.model}">Модель</a>
                                                </td>
                                                <td th:text="${product.manufacturer != null ? product.manufacturer : '-'}">Производитель</td>
                                                <td>
                                                    <div th:if="${product.minerDetail != null}" class="d-flex align-items-center gap-2">
                                                        <a th:href="@{/private/miner-details/{id}(id=${product.minerDetail.id})}" 
                                                           class="text-primary hover-text-decoration-underline"
                                                           th:utext="${product.minerDetail.standardName}">
                                                            Название
                                                        </a>
                                                        <button type="button" 
                                                                class="btn btn-sm btn-info" 
                                                                style="min-width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                                                th:attr="data-product-id=${product.id}, data-product-model=${product.model}, data-miner-detail-id=${product.minerDetail != null ? product.minerDetail.id : ''}, data-miner-detail-name=${product.minerDetail != null ? product.minerDetail.standardName : ''}"
                                                                title="Редактировать связь">
                                                            <i class="fe fe-edit" style="font-size: 0.875rem;"></i>
                                                        </button>
                                                        <a th:href="@{/private/miner-details/{id}(id=${product.minerDetail.id})}" 
                                                           target="_blank"
                                                           class="btn btn-sm btn-outline-primary" 
                                                           style="min-width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                                           title="Открыть страницу редактирования MinerDetail">
                                                            <i class="fe fe-external-link" style="font-size: 0.875rem;"></i>
                                                        </a>
                                                    </div>
                                                    <div th:unless="${product.minerDetail != null}" class="d-flex align-items-center gap-2">
                                                        <span class="text-muted">Не привязан</span>
                                                        <button type="button" 
                                                                class="btn btn-sm btn-primary" 
                                                                style="min-width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                                                th:attr="data-product-id=${product.id}, data-miner-detail-id='', data-miner-detail-name=''"
                                                                title="Привязать к MinerDetail">
                                                            <i class="fe fe-link" style="font-size: 0.875rem;"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span th:text="${#lists.size(product.offers)}">0</span>
                                                </td>
                                                <td>
                                                    <span th:if="${product.minPrice != null}">
                                                        <span th:text="${#numbers.formatDecimal(product.minPrice, 0, 'COMMA', 2, 'POINT')}">0</span>
                                                        <span th:if="${product.offers != null and !#lists.isEmpty(product.offers)}" 
                                                              th:text="${product.offers[0].currency != null ? product.offers[0].currency : 'u'}">u</span>
                                                        <span th:unless="${product.offers != null and !#lists.isEmpty(product.offers)}">u</span>
                                                    </span>
                                                    <span th:unless="${product.minPrice != null}">-</span>
                                                </td>
                                                <td th:text="${#temporals.format(product.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 00:00</td>
                                                <td th:text="${#temporals.format(product.updatedAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 00:00</td>
                                                <td>
                                                    <a th:if="${product.minerDetail != null}" 
                                                       th:href="@{/products/{id}(id=${product.minerDetail.id})}" 
                                                       class="btn btn-sm btn-primary">
                                                        Подробнее
                                                    </a>
                                                    <a th:unless="${product.minerDetail != null}" 
                                                       th:href="@{/products/{id}(id=${product.id})}" 
                                                       class="btn btn-sm btn-primary">
                                                        Подробнее
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Пагинация -->
                                <nav th:if="${productsPage.totalPages > 1}" class="mt-3" aria-label="Навигация по страницам">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item" th:classappend="${productsPage.first} ? 'disabled'">
                                            <a class="page-link" 
                                               th:href="@{/private/products/table(page=${productsPage.number - 1}, sortBy=${sortBy}, sortDir=${sortDir}, manufacturer=${currentManufacturer != null and currentManufacturer != '' ? currentManufacturer : null})}">Предыдущая</a>
                                        </li>
                                        <li th:each="pageNum : ${#numbers.sequence(0, productsPage.totalPages - 1)}" 
                                            class="page-item" 
                                            th:classappend="${pageNum == productsPage.number} ? 'active'">
                                            <a class="page-link" 
                                               th:href="@{/private/products/table(page=${pageNum}, sortBy=${sortBy}, sortDir=${sortDir}, manufacturer=${currentManufacturer != null and currentManufacturer != '' ? currentManufacturer : null})}"
                                               th:text="${pageNum + 1}">1</a>
                                        </li>
                                        <li class="page-item" th:classappend="${productsPage.last} ? 'disabled'">
                                            <a class="page-link" 
                                               th:href="@{/private/products/table(page=${productsPage.number + 1}, sortBy=${sortBy}, sortDir=${sortDir}, manufacturer=${currentManufacturer != null and currentManufacturer != '' ? currentManufacturer : null})}">Следующая</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- row closed -->
            </div>
        </div>
        <!-- End::app-content -->

        <!-- Footer Start -->
        <footer class="footer mt-auto py-3 bg-white text-center">
            <div class="container">
                <span class="text-muted">© 2025 <a href="javascript:void(0);" class="text-dark fw-semibold">MinerHive</a>. Все права защищены.</span>
            </div>
        </footer>
        <!-- Footer End -->
    </div>

    <!-- Scroll To Top -->
    <div class="scrollToTop">
        <span class="arrow"><i class="las la-angle-double-up"></i></span>
    </div>
    <div id="responsive-overlay"></div>
    <!-- Scroll To Top -->

    <!-- Модальное окно для выбора MinerDetail -->
    <div class="modal fade" id="editMinerDetailModal" tabindex="-1" aria-labelledby="editMinerDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMinerDetailModalLabel">Редактировать связь с MinerDetail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="minerDetailModalContent">
                    <!-- Информация о продукте -->
                        <div class="mb-3">
                        <label class="form-label">Продукт:</label>
                        <input type="text" class="form-control" id="productNameInput" readonly>
                        </div>
                    
                    <!-- Выбор MinerDetail -->
                        <div class="mb-3">
                        <label class="form-label">Выберите MinerDetail:</label>
                        
                        <!-- Поиск и кнопка создания -->
                        <div class="d-flex gap-2 mb-2">
                            <div class="input-group flex-grow-1">
                                <span class="input-group-text">
                                    <i class="fe fe-search"></i>
                                </span>
                                <input type="text" class="form-control" id="minerDetailSearch" placeholder="Поиск по названию, производителю или серии...">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" style="display: none;">
                                    <i class="fe fe-x"></i>
                                </button>
                            </div>
                            <button type="button" class="btn btn-primary" id="createNewMinerDetailBtn">
                                <i class="fe fe-plus"></i> Создать новый
                                </button>
                            </div>
                        
                        <!-- Кнопка "Не привязан" -->
                            <div class="mb-2">
                            <button type="button" class="btn btn-outline-secondary" id="unlinkMinerDetailBtn">
                                <i class="fe fe-minus-circle"></i> Не привязан
                                </button>
                            </div>
                                </div>
                    
                    <!-- Контейнер для таблицы -->
                    <div id="minerDetailsTableContainer" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
            </div>
        </div>
    </div>
    
                    <!-- Счетчик записей -->
                    <div class="mt-2 text-muted small" id="minerDetailsCounter">
                        Показано 0 из 0
                </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveMinerDetailBtn" style="display: none;">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Popper JS -->
    <script th:src="@{/bootstrap-theme/assets/libs/@popperjs/core/umd/popper.min.js}" src="../assets/libs/@popperjs/core/umd/popper.min.js"></script>

    <!-- Bootstrap JS -->
    <script th:src="@{/bootstrap-theme/assets/libs/bootstrap/js/bootstrap.bundle.min.js}" src="../assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Defaultmenu JS -->
    <script th:src="@{/bootstrap-theme/assets/js/defaultmenu.min.js}" src="../assets/js/defaultmenu.min.js"></script>

    <!-- Node Waves JS-->
    <script th:src="@{/bootstrap-theme/assets/libs/node-waves/waves.min.js}" src="../assets/libs/node-waves/waves.min.js"></script>

    <!-- Sticky JS -->
    <script th:src="@{/bootstrap-theme/assets/js/sticky.js}" src="../assets/js/sticky.js"></script>

    <!-- Simplebar JS -->
    <script th:src="@{/bootstrap-theme/assets/libs/simplebar/simplebar.min.js}" src="../assets/libs/simplebar/simplebar.min.js"></script>
    <script th:src="@{/bootstrap-theme/assets/js/simplebar.js}" src="../assets/js/simplebar.js"></script>

    <!-- Color Picker JS -->
    <script th:src="@{/bootstrap-theme/assets/libs/@simonwep/pickr/pickr.es5.min.js}" src="../assets/libs/@simonwep/pickr/pickr.es5.min.js"></script>
    
    <!-- Custom-Switcher JS -->
    <script th:src="@{/bootstrap-theme/assets/js/custom-switcher.min.js}" src="../assets/js/custom-switcher.min.js"></script>

    <!-- Custom JS -->
    <script th:src="@{/bootstrap-theme/assets/js/custom.js}" src="../assets/js/custom.js"></script>
    
    <!-- Main Theme Js - Loaded at the end to ensure DOM elements are ready -->
    <script th:src="@{/bootstrap-theme/assets/js/main.js}" src="../assets/js/main.js"></script>

    <!-- JavaScript для модального окна -->
    <script>
        let currentProductId = null;
        let selectedMinerDetailId = null;
        let currentMinerDetailPage = 0;
        let minerDetailSearchQuery = '';
        let hasMoreMinerDetails = true;
        let isLoadingMinerDetails = false;
        let searchTimeout = null;
        
        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function openEditMinerDetailModal(button) {
            const modalElement = document.getElementById('editMinerDetailModal');
            const container = document.getElementById('minerDetailsTableContainer');
            
            if (!modalElement || !container) {
                console.error('Модальное окно не найдено!');
                return;
            }
            
            currentProductId = button.getAttribute('data-product-id');
            const productModel = button.getAttribute('data-product-model') || button.closest('tr').querySelector('td:nth-child(2)')?.textContent?.trim() || 'Неизвестно';
            const currentMinerDetailId = button.getAttribute('data-miner-detail-id');
            
            selectedMinerDetailId = currentMinerDetailId ? parseInt(currentMinerDetailId) : null;
            currentMinerDetailPage = 0;
            minerDetailSearchQuery = '';
            hasMoreMinerDetails = true;
            
            document.getElementById('productNameInput').value = productModel;
            document.getElementById('minerDetailSearch').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            document.getElementById('saveMinerDetailBtn').style.display = selectedMinerDetailId ? 'inline-block' : 'none';
            
            const unlinkBtn = document.getElementById('unlinkMinerDetailBtn');
            if (selectedMinerDetailId) {
                unlinkBtn.classList.remove('btn-outline-secondary');
                unlinkBtn.classList.add('btn-primary');
            } else {
                unlinkBtn.classList.remove('btn-primary');
                unlinkBtn.classList.add('btn-outline-secondary');
            }
            
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
            document.getElementById('minerDetailsCounter').textContent = 'Показано 0 из 0';
            
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            loadMinerDetails(true);
        }
        
        function loadMinerDetails(resetTable) {
            if (isLoadingMinerDetails) return;
            
            isLoadingMinerDetails = true;
            const container = document.getElementById('minerDetailsTableContainer');
            const tableBody = container.querySelector('tbody');
            
            if (resetTable) {
                container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
                currentMinerDetailPage = 0;
            } else if (tableBody) {
                const loadingRow = document.createElement('tr');
                loadingRow.id = 'loadingRow';
                loadingRow.innerHTML = '<td colspan="5" class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></td>';
                tableBody.appendChild(loadingRow);
            }
            
            const url = new URL('/api/miner-details/search', window.location.origin);
            url.searchParams.append('page', currentMinerDetailPage);
            url.searchParams.append('size', '20');
            if (minerDetailSearchQuery) {
                url.searchParams.append('search', minerDetailSearchQuery);
            }
            
            fetch(url.toString(), {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error('Ошибка загрузки данных: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                isLoadingMinerDetails = false;
                
                if (resetTable) {
                    let html = '<div class="table-responsive">';
                    html += '<table class="table table-hover">';
                html += '<thead><tr>';
                html += '<th>ID</th>';
                html += '<th>НАЗВАНИЕ</th>';
                html += '<th>ПРОИЗВОДИТЕЛЬ</th>';
                html += '<th>СЕРИЯ</th>';
                html += '<th>ТОВАРОВ</th>';
                html += '</tr></thead>';
                    html += '<tbody>';
                    container.innerHTML = html;
                }
                
                const tableBody = container.querySelector('tbody');
                const loadingRow = tableBody.querySelector('#loadingRow');
                if (loadingRow) {
                    loadingRow.remove();
                }
                
                if (data.content && data.content.length > 0) {
                    data.content.forEach(item => {
                        const isSelected = selectedMinerDetailId && item.id === selectedMinerDetailId;
                        const row = document.createElement('tr');
                        row.className = 'miner-detail-row' + (isSelected ? ' table-primary' : '');
                        row.style.cursor = 'pointer';
                        row.setAttribute('data-miner-detail-id', item.id);
                        row.innerHTML = 
                            '<td>' + escapeHtml(String(item.id || '')) + '</td>' +
                            '<td>' + escapeHtml(String(item.standardName || '-')) + '</td>' +
                            '<td>' + escapeHtml(String(item.manufacturer || '-')) + '</td>' +
                            '<td>' + escapeHtml(String(item.series || '-')) + '</td>' +
                            '<td><span class="badge bg-info">' + escapeHtml(String(item.productCount || 0)) + '</span></td>';
                        tableBody.appendChild(row);
                    });
                    
                    currentMinerDetailPage++;
                    hasMoreMinerDetails = data.hasNext || false;
                } else {
                    if (resetTable) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Нет данных</td></tr>';
                    }
                    hasMoreMinerDetails = false;
                }
                
                if (resetTable) {
                    container.innerHTML += '</tbody></table></div>';
                    document.getElementById('minerDetailsCounter').textContent = 
                        'Показано ' + (data.content ? data.content.length : 0) + ' из ' + (data.totalElements || 0);
                } else {
                    const currentCount = container.querySelectorAll('.miner-detail-row').length;
                    document.getElementById('minerDetailsCounter').textContent = 
                        'Показано ' + currentCount + ' из ' + (data.totalElements || 0);
                }
                
                setupRowClickHandlers();
            })
            .catch(error => {
                isLoadingMinerDetails = false;
                console.error('Ошибка при загрузке MinerDetails:', error);
                if (resetTable) {
                    container.innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных: ' + escapeHtml(error.message) + '</div>';
                } else {
                    const loadingRow = container.querySelector('#loadingRow');
                    if (loadingRow) {
                        loadingRow.remove();
                    }
                }
            });
        }
        
        function setupRowClickHandlers() {
            const rows = document.querySelectorAll('.miner-detail-row');
            rows.forEach(row => {
                row.addEventListener('click', function() {
                    const minerDetailId = parseInt(this.getAttribute('data-miner-detail-id'));
                    
                    if (selectedMinerDetailId === minerDetailId) {
                        selectedMinerDetailId = null;
                        this.classList.remove('table-primary');
                        document.getElementById('saveMinerDetailBtn').style.display = 'none';
                        const unlinkBtn = document.getElementById('unlinkMinerDetailBtn');
                        unlinkBtn.classList.remove('btn-primary');
                        unlinkBtn.classList.add('btn-outline-secondary');
                    } else {
                        selectedMinerDetailId = minerDetailId;
                        rows.forEach(r => {
                r.classList.remove('table-primary');
            });
                        this.classList.add('table-primary');
                        document.getElementById('saveMinerDetailBtn').style.display = 'inline-block';
            const unlinkBtn = document.getElementById('unlinkMinerDetailBtn');
            unlinkBtn.classList.remove('btn-primary');
            unlinkBtn.classList.add('btn-outline-secondary');
                    }
                });
            });
        }
        
        function selectUnlinkOption() {
            selectedMinerDetailId = null;
            document.querySelectorAll('.miner-detail-row').forEach(r => {
                r.classList.remove('table-primary');
            });
            document.getElementById('saveMinerDetailBtn').style.display = 'inline-block';
            const unlinkBtn = document.getElementById('unlinkMinerDetailBtn');
            unlinkBtn.classList.remove('btn-outline-secondary');
            unlinkBtn.classList.add('btn-primary');
        }
        
        function handleSearchInput() {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('minerDetailSearch').value.trim();
                minerDetailSearchQuery = query;
                currentMinerDetailPage = 0;
                hasMoreMinerDetails = true;
                
                if (query) {
                    document.getElementById('clearSearchBtn').style.display = 'block';
                } else {
                    document.getElementById('clearSearchBtn').style.display = 'none';
                }
                
                loadMinerDetails(true);
            }, 500);
        }
        
        function clearSearch() {
            document.getElementById('minerDetailSearch').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            minerDetailSearchQuery = '';
            currentMinerDetailPage = 0;
            hasMoreMinerDetails = true;
            loadMinerDetails(true);
        }
        
        function handleScroll() {
            const container = document.getElementById('minerDetailsTableContainer');
            if (!container) return;
            
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            
            if (scrollTop + clientHeight >= scrollHeight * 0.8 && !isLoadingMinerDetails && hasMoreMinerDetails) {
                loadMinerDetails(false);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const productsTable = document.getElementById('productsTable');
            
            if (productsTable) {
                productsTable.addEventListener('click', function(e) {
                    const button = e.target.closest('button[data-product-id]');
                    if (button && (button.classList.contains('btn-info') || button.classList.contains('btn-primary'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        openEditMinerDetailModal(button);
                    }
                });
            }
            
            const saveBtn = document.getElementById('saveMinerDetailBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    if (!currentProductId) {
                        alert('Ошибка: ID продукта не указан');
                    return;
                }
                
                    saveMinerDetailLink();
                });
            }
            
            const searchInput = document.getElementById('minerDetailSearch');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearchInput);
            }
            
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearSearch);
            }
            
            const container = document.getElementById('minerDetailsTableContainer');
            if (container) {
                container.addEventListener('scroll', handleScroll);
            }
            
            const unlinkBtn = document.getElementById('unlinkMinerDetailBtn');
            if (unlinkBtn) {
                unlinkBtn.addEventListener('click', selectUnlinkOption);
            }
            
            const createBtn = document.getElementById('createNewMinerDetailBtn');
            if (createBtn) {
                createBtn.addEventListener('click', function() {
                    alert('Функция создания нового MinerDetail будет добавлена позже');
                });
            }
        });
        
        function saveMinerDetailLink() {
            const saveButton = document.getElementById('saveMinerDetailBtn');
            const originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Сохранение...';
            
            const data = {
                productId: parseInt(currentProductId),
                minerDetailId: selectedMinerDetailId
            };
            
            fetch('/api/products/update-miner-detail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=UTF-8'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editMinerDetailModal'));
                    if (modal) {
                        modal.hide();
                    }
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении связи:', error);
                alert('Ошибка при сохранении: ' + error.message);
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            });
        }
    </script>

</body>
</html>
